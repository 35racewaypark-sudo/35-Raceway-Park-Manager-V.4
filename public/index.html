<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>35 Raceway Park - Race Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --orange-primary: #f97316;
            --orange-dark: #ea580c;
            --orange-light: #fb923c;
            --orange-50: #fff7ed;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
            min-height: 100vh;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-button {
            position: relative;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: var(--orange-primary);
            background-color: var(--orange-50);
            border-bottom: 3px solid var(--orange-primary);
        }
        
        .tab-button:hover:not(.active) {
            background-color: var(--gray-50);
            color: var(--orange-dark);
        }
        
        /* Modern Card Styling */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Modern Button Styling */
        .btn-primary {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(249, 115, 22, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            color: var(--gray-800);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary:active {
            transform: translateY(0);
        }
        
        /* Apply button styling to all buttons globally */
        button:not(.tab-button):not(.settings-tab-btn):not([class*="edit-"]):not([class*="delete-"]):not([class*="save-"]):not([class*="no-results"]) {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        button:not(.tab-button):not(.settings-tab-btn):hover:not([class*="edit-"]):not([class*="delete-"]):not([class*="save-"]):not([class*="no-results"]) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.15);
        }
        
        button:not(.tab-button):not(.settings-tab-btn):active:not([class*="edit-"]):not([class*="delete-"]):not([class*="save-"]):not([class*="no-results"]) {
            transform: translateY(0);
        }
        
        /* Specific button type styles with bounce */
        .bg-orange-500, .bg-orange-600, .bg-green-500, .bg-green-600, .bg-blue-500, .bg-blue-600, .bg-red-500, .bg-red-600 {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }
        
        .bg-orange-500:hover, .bg-orange-600:hover, .bg-green-500:hover, .bg-green-600:hover, .bg-blue-500:hover, .bg-blue-600:hover, .bg-red-500:hover, .bg-red-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.3);
        }
        
        .bg-orange-500:active, .bg-orange-600:active, .bg-green-500:active, .bg-green-600:active, .bg-blue-500:active, .bg-blue-600:active, .bg-red-500:active, .bg-red-600:active {
            transform: translateY(0);
        }
        
        /* Modern Input Styling */
        .input-modern {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        /* Custom modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.2s;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 500px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: scale(1);
        }
        .hidden {
            display: none;
        }
        .driver-item {
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 8px;
            background-color: white;
            border: 2px solid var(--gray-200);
            transition: all 0.2s ease;
        }
        .driver-item:hover {
            border-color: var(--orange-primary);
            background-color: var(--orange-50);
            transform: translateX(4px);
        }
        .setup-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Badge Styling */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-primary {
            background: var(--orange-50);
            color: var(--orange-dark);
        }
        
        /* Header Gradient */
        .header-gradient {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }
        
        /* Stat Card */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--orange-primary);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* Settings Tabs */
        .settings-tab-content {
            display: none;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        .settings-tab-btn.active {
            color: var(--orange-primary);
            border-bottom-color: var(--orange-primary);
        }
        
        /* V3: Enhanced Lineup Display - Feature #3 */
        .v3-lineup-row {
            padding: 1.5rem 1rem;
            border-bottom: 2px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        
        .v3-lineup-row:hover {
            background-color: #fef3c7;
        }
        
        .v3-driver-number {
            font-size: 2.5em;
            font-weight: 800;
            color: #f97316;
            line-height: 1;
        }
        
        .v3-driver-name {
            font-size: 1.75em;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.2;
        }
        
        .v3-driver-location {
            font-size: 1em;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .v3-position-indicator {
            font-size: 1.5em;
            font-weight: 700;
            color: #374151;
        }
        
        /* Print-specific lineup styling */
        @media print {
            .v3-lineup-row {
                page-break-inside: avoid;
            }
            
            .v3-driver-number {
                font-size: 2em;
            }
            
            .v3-driver-name {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- Modern Header -->
        <header class="header-gradient rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-2 rounded-xl shadow-lg">
                        <img src="35_Logo2.png" alt="35 Raceway Park" class="w-16 h-16 object-contain">
                            
                        
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-white tracking-tight">35 Raceway Park</h1>
                        <p class="text-orange-200 text-lg font-medium">Race Manager Pro</p>
                    </div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <label for="eventDate" class="block text-sm font-semibold text-orange-200 mb-2">Event Date</label>
                    <input type="date" id="eventDate" class="input-modern bg-white text-gray-800 font-semibold">
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-6 overflow-x-auto">
            <div class="card flex border-b-0 whitespace-nowrap">
                <button data-tab="driver-class-management" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent active">Drivers & Classes</button>
                <button data-tab="registration" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Registration</button>
                <button data-tab="race-setup" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Race Setup</button>
                <button data-tab="heat-races" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Heat Races</button>
                <button data-tab="b-main" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">B-Main</button>
                <button data-tab="feature" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Feature</button>
                <button data-tab="race-results" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Results</button>
                <button data-tab="points" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Points</button>
                <button data-tab="payouts" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Payouts</button>
                <button data-tab="history" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">History</button>
                <button data-tab="finalize" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Finalize</button>
                <button data-tab="settings" class="tab-button p-4 font-semibold text-gray-600 border-b-2 border-transparent">Settings</button>
            </div>
        </div>

        <main class="card p-8">
            <!-- Driver/Class Management -->
            <div id="driver-class-management" class="tab-content active">
                <h2 class="text-2xl font-bold mb-4">Driver & Class Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Class Management -->
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Manage Classes</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="newClassName" type="text" placeholder="Enter new class name" class="flex-grow p-2 border rounded-md">
                            <button id="createClassBtn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">Create Class</button>
                        </div>
                        <ul id="classList" class="space-y-2">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    <!-- Driver Management -->
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Manage Drivers</h3>
                         <div class="flex justify-between items-center mb-4">
                             <select id="driverClassFilter" class="p-2 border rounded-md">
                                 <option value="">Filter by Class</option>
                                 <!-- JS will populate this -->
                             </select>
                            <button id="addDriverBtn" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600">Add Driver</button>
                         </div>
                        <div class="overflow-y-auto h-96">
                            <table class="w-full text-left">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">Name</th>
                                        <th class="p-2">Number</th>
                                        <th class="p-2">License</th>
                                        <th class="p-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="driverList">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4">
                            <button id="generateTestDataBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">Generate 2025 Season Data</button>
                       </div>
                    </div>
                </div>
            </div>

            <!-- Registration -->
            <div id="registration" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Event Registration</h2>
                <select id="registrationClassSelect" class="p-2 border rounded-md mb-4 w-full md:w-1/3">
                    <option value="">Select a class to register...</option>
                    <!-- JS will populate classes -->
                </select>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Available Drivers</h3>
                        <div id="availableDrivers" class="p-3 bg-gray-50 rounded-md h-96 overflow-y-auto space-y-2">
                           <!-- JS will populate this list -->
                           <p class="text-gray-500">Select a class to see available drivers.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Registered Drivers</h3>
                        <div id="registeredDrivers" class="p-3 bg-orange-50 rounded-md h-96 overflow-y-auto space-y-2">
                            <!-- JS will populate this list -->
                            <p class="text-gray-500">Registered drivers for the selected class will appear here.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <button id="completeRegistrationBtn" class="bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700 disabled:bg-gray-400" disabled>Complete Registration for Class</button>
                </div>
            </div>

            <!-- Race Setup -->
            <div id="race-setup" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Race Setup</h2>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="raceSetupClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class to set up...</option>
                        <!-- JS will populate classes with completed registration -->
                    </select>
                </div>
                <!-- Setup options -->
                <div id="raceSetupOptions" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                    <h3 class="text-xl font-semibold mb-3">Options</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Race Format -->
                        <div>
                            <label class="font-medium block mb-2">Race Format</label>
                             <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="skipHeatsCheckbox" class="mr-2 h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="skipHeatsCheckbox">Skip Heats & Go to Feature</label>
                                </div>
                                <div id="standardHeatSetup" class="setup-group space-y-2 pl-6 border-l-2">
                                    <p>Total Drivers: <span id="registeredDriverCount" class="font-bold">0</span></p>
                                    <div>
                                        <label for="manualHeatCount" class="text-sm">Number of Heats:</label>
                                        <input type="number" id="manualHeatCount" min="1" class="p-1 border rounded-md w-24">
                                    </div>
                                    <p id="heatBreakdownText" class="text-sm text-gray-600 h-4"></p>
                                </div>
                            </div>
                        </div>
                        <!-- B-Main Setup -->
                        <div id="bMainSetupContainer" class="setup-group">
                            <label class="font-medium block mb-2">B-Main Setup</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enableBMain" class="mr-2 h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="enableBMain">Enable B-Main</label>
                                </div>
                                <div><input type="number" id="featureStartCount" placeholder="# to start feature" class="p-1 border rounded-md w-full"></div>
                                <div><input type="number" id="heatTransferCount" placeholder="# transfer / heat" class="p-1 border rounded-md w-full"></div>
                                <p id="bMainBreakdownText" class="text-sm text-gray-600 h-4 mt-1"></p>
                            </div>
                        </div>
                        <!-- Points Setup -->
                        <div>
                            <label class="font-medium">Points Option</label>
                            <div class="flex flex-col items-start gap-2 mt-2">
                                <label class="flex items-center"><input type="radio" name="pointsOption" value="normal" class="mr-2" checked> Normal Points</label>
                                <label class="flex items-center"><input type="radio" name="pointsOption" value="double" class="mr-2"> Double Points</label>
                                <label class="flex items-center"><input type="radio" name="pointsOption" value="none" class="mr-2"> No Points</label>
                                <!-- V3: Show-Up Points Toggle -->
                                <div class="mt-3 pt-3 border-t w-full">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showUpPointsCheckbox" class="mr-2 h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500" checked>
                                        <span class="text-sm">Award Show-Up Points (<span id="showUpPointsDisplay">0</span> pts)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Payout Structure -->
                        <div>
                            <label class="font-medium block mb-2">Payout Structure</label>
                            <select id="payoutStructureSelect" class="input-modern w-full">
                                <option value="">No Payout</option>
                                <!-- JS will populate payout structures -->
                            </select>
                            <p class="text-xs text-gray-500 mt-2">Select a payout structure for this event</p>
                        </div>
                    </div>
                </div>
                <!-- Driver Lineup Setup -->
                 <div id="lineupSetupContainer" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-semibold">Set Lineup</h3>
                        <button id="randomPillDrawBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Random Pill Draw</button>
                    </div>
                    <div class="overflow-y-auto h-80">
                         <table class="w-full text-left">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2">Name</th>
                                    <th class="p-2">Number</th>
                                    <th class="p-2 w-48">Pill # / Qual. Time</th>
                                </tr>
                            </thead>
                            <tbody id="lineupSetupList">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                 </div>
                 <div class="mt-4 text-right">
                    <button id="generateLineupsBtn" class="bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700 disabled:bg-gray-400 hidden">Generate Lineups</button>
                </div>
            </div>
            
            <!-- Heat Races -->
            <div id="heat-races" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Heat Races</h2>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="heatRacesClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class to view heat lineups...</option>
                        <!-- JS will populate classes with generated heats -->
                    </select>
                    <button id="printHeatsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Print Lineups</button>
                    <button id="printPromoterSheetBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Print Promoter Sheet</button>
                    <button id="exportHeatLineupsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Lineups CSV</button>
                    <button id="exportHeatResultsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Results CSV</button>
                    <button id="resetToRegistrationBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 hidden">Reset to Registration</button>
                </div>
                <div id="heatLineupsContainer" class="space-y-6">
                    <!-- JS will render heat lineups here -->
                    <p class="text-gray-500 text-center">Select a class to see heat lineups.</p>
                </div>
                 <div class="mt-6 text-right">
                    <button id="finalizeHeatsBtn" class="bg-orange-500 text-white px-6 py-2 rounded-md hover:bg-orange-600 hidden">Finalize Heat Results & Set Next Lineup</button>
                </div>
            </div>

            <!-- B-Main -->
            <div id="b-main" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">B-Main</h2>
                 <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="bMainClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class...</option>
                        <!-- JS will populate -->
                    </select>
                    <button id="printBMainBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Print Lineup</button>
                    <button id="printBMainPromoterSheetBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Print Promoter Sheet</button>
                    <button id="exportBMainLineupBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Lineup CSV</button>
                    <button id="exportBMainResultsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Results CSV</button>
                </div>
                <div id="bMainContainer" class="space-y-6">
                    <p class="text-gray-500 text-center">Select a class to see B-Main lineup.</p>
                </div>
                 <div class="mt-6 text-right">
                    <button id="finalizeBMainBtn" class="bg-orange-500 text-white px-6 py-2 rounded-md hover:bg-orange-600 hidden">Finalize B-Main & Set Feature Lineup</button>
                </div>
            </div>

            <!-- Feature -->
            <div id="feature" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Feature Race</h2>
                 <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="featureClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class...</option>
                        <!-- JS will populate -->
                    </select>
                     <button id="printFeatureBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Print Lineup</button>
                     <button id="printFeaturePromoterSheetBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Print Promoter Sheet</button>
                     <button id="exportFeatureLineupBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Lineup CSV</button>
                     <button id="exportFeatureResultsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Results CSV</button>
                </div>
                 <div id="featureInvertControls" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                    <h3 class="text-xl font-semibold mb-3">Invert Options</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <label><input type="radio" name="invertOption" value="0" checked> No Invert</label>
                        <label><input type="radio" name="invertOption" value="4"> Top 4</label>
                        <label><input type="radio" name="invertOption" value="6"> Top 6</label>
                        <label><input type="radio" name="invertOption" value="8"> Top 8</label>
                        <label><input type="radio" name="invertOption" value="full"> Full Invert</label>
                        <label><input type="radio" name="invertOption" value="custom"> Custom</label>
                        <input type="number" id="customInvertNum" min="2" placeholder="How many?" 
                               class="hidden p-2 border rounded-md w-24" style="display:none;">
                        <button id="resetInvertBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 text-sm">Reset Invert</button>
                    </div>
                </div>
                <div id="featureContainer" class="space-y-6">
                     <p class="text-gray-500 text-center">Select a class to see Feature lineup.</p>
                </div>
                 <div class="mt-6 text-right">
                    <button id="finalizeFeatureBtn" class="bg-orange-500 text-white px-6 py-2 rounded-md hover:bg-orange-600 hidden">Finalize Race & Award Points</button>
                </div>
            </div>

            <!-- Race Results -->
            <div id="race-results" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Race Results</h2>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                     <select id="raceResultsClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class to view results...</option>
                    </select>
                    <button id="printResultsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Print Full Results</button>
                    <button id="printPayoutSheetBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üí∞ Print Payout Sheet</button>
                    <button id="viewHistoryBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">üìö View Race History</button>
                </div>
                <div id="raceResultsContainer">
                    <p class="text-gray-500 text-center">Select a class to see the full race report.</p>
                </div>
            </div>

            <!-- Points -->
            <div id="points" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Championship Points</h2>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="pointsClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class to view points...</option>
                    </select>
                    <button id="printPointsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Print Points</button>
                    <button id="exportPointsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">üìä Export Points CSV</button>
                </div>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2">Rank</th>
                                <th class="p-2">Driver Name</th>
                                <th class="p-2">Points</th>
                                <th class="p-2">Starts</th>
                                <th class="p-2">Feature Wins</th>
                                <th class="p-2">Heat Wins</th>
                                <th class="p-2">Top 5s</th>
                                <th class="p-2">Top 10s</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pointsList">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Payouts -->
            <div id="payouts" class="tab-content">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Payout Management</h2>
                    <p class="text-gray-600">Track and manage driver payouts throughout the season</p>
                </div>
                
                <!-- Payout Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Paid This Year</div>
                            <div class="bg-orange-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-gray-900" id="totalYearlyPayout">$0</div>
                        <div class="text-xs text-gray-500 mt-1">Across all classes</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Events This Year</div>
                            <div class="bg-blue-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-gray-900" id="totalEventsWithPayouts">0</div>
                        <div class="text-xs text-gray-500 mt-1">With payouts distributed</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Average Per Event</div>
                            <div class="bg-green-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-gray-900" id="avgPayoutPerEvent">$0</div>
                        <div class="text-xs text-gray-500 mt-1">Per race weekend</div>
                    </div>
                </div>
                
                <!-- Driver Payout Search -->
                <div class="card p-6 mb-6">
                    <div class="flex flex-wrap gap-4 items-center mb-6">
                        <div class="flex-grow">
                            <label for="payoutClassFilter" class="block text-sm font-semibold text-gray-700 mb-2">Filter by Class</label>
                            <select id="payoutClassFilter" class="input-modern w-full">
                                <option value="">All Classes</option>
                                <!-- JS will populate -->
                            </select>
                        </div>
                        <div class="flex-grow">
                            <label for="payoutDriverSearch" class="block text-sm font-semibold text-gray-700 mb-2">Search Driver</label>
                            <input type="text" id="payoutDriverSearch" placeholder="Search by name or number..." class="input-modern w-full">
                        </div>
                        <div class="pt-7">
                            <button id="printPayoutsBtn" class="btn-secondary">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Print Report
                            </button>
                            <button id="exportPayoutsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 ml-2">
                                üìä Export All Payouts CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Driver Payout Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr class="border-b-2 border-gray-200">
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Driver</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Number</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Class</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Winnings</th>
                                    <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Events</th>
                                    <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payoutsList">
                                <!-- JS will populate -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- History -->
            <div id="history" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Event History</h2>
                 <div class="flex flex-wrap gap-4 items-center mb-4">
                    <select id="historyClassSelect" class="p-2 border rounded-md flex-grow">
                        <option value="">Select a class to view history...</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <h3 class="text-lg font-semibold mb-2">Past Event Dates</h3>
                        <div id="historyDateList" class="p-3 bg-gray-50 rounded-md h-96 overflow-y-auto space-y-2">
                            <p class="text-gray-500">Select a class to see past event dates.</p>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">Historical Race Results</h3>
                            <button id="printHistoryBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 hidden">Print History</button>
                        </div>
                        <div id="historyResultsContainer" class="p-3 bg-orange-50 rounded-md h-96 overflow-y-auto">
                            <p class="text-gray-500">Select an event date to see results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finalize -->
            <div id="finalize" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Data & Season Management</h2>
                <div class="max-w-md mx-auto text-center space-y-8">
                    <!-- V4: Weekend Notes Section -->
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Weekend Notes</h3>
                        <p class="text-sm text-gray-600 mb-4">Document important information about this race weekend for your records</p>
                        <button id="weekendNotesBtn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 w-full">‚úçÔ∏è Add/Edit Weekend Notes</button>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Event & Season Reset</h3>
                        <div class="space-y-4">
                           <button id="finalizeWeekendBtn" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 w-full">Finalize Race Weekend</button>
                           <button id="finalizeSeasonBtn" class="bg-red-800 text-white px-6 py-3 rounded-md hover:bg-red-900 w-full">Finalize Season (Complete Reset)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings" class="tab-content">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Settings & Configuration</h2>
                    <p class="text-gray-600">Manage points and payout structures</p>
                </div>
                
                <!-- Settings Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="settings-tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-orange-600 active" data-settings-tab="points">
                        Point Settings
                    </button>
                    <button class="settings-tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-orange-600" data-settings-tab="payouts">
                        Payout Structures
                    </button>
                </div>
                
                <!-- Points Settings Section -->
                <div id="pointsSettings" class="settings-tab-content active">
                    <!-- V3: Show-Up Points Section -->
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Show-Up Points</h3>
                        <p class="text-sm text-gray-600 mb-4">Points awarded to drivers just for registering. These points are awarded even if the event is rained out.</p>
                        <div class="flex items-center gap-4">
                            <label for="showUpPoints" class="font-medium">Points Per Registration:</label>
                            <input type="number" id="showUpPoints" min="0" value="0" class="w-32 p-2 border rounded-md">
                            <span class="text-sm text-gray-500">(Set to 0 to disable)</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Feature Points</h3>
                            <div id="featurePointsContainer" class="space-y-2 max-h-96 overflow-y-auto pr-4">
                                <!-- JS will generate 30 input fields -->
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Heat Points</h3>
                            <div id="heatPointsContainer" class="space-y-2 max-h-96 overflow-y-auto pr-4">
                                <!-- JS will generate 30 input fields -->
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="savePointsBtn" class="btn-primary">Save Point Settings</button>
                    </div>
                </div>
                
                <!-- Payout Structures Section -->
                <div id="payoutSettings" class="settings-tab-content hidden">
                    <!-- Driver Payout History Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Driver Payout History</h3>
                        <div id="driverPayoutHistory" class="bg-white rounded-lg shadow-sm">
                            <!-- JS will populate -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Payout Structure Templates</h3>
                                <p class="text-sm text-gray-600 mt-1">Create reusable payout structures for different event types</p>
                            </div>
                            <button id="createPayoutStructureBtn" class="btn-primary">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                New Structure
                            </button>
                        </div>
                        
                        <!-- Payout Structures List -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="payoutStructuresList">
                            <!-- JS will populate -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="confirmationModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div id="confirmationInputContainer" class="hidden my-4">
                 <input type="text" id="confirmationInput" placeholder='Type phrase to confirm' class="w-full p-2 border rounded-md">
            </div>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="modalConfirmBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="driverModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh;">
            <h3 id="driverModalTitle" class="text-xl font-bold mb-4">Add New Driver</h3>
            <div style="max-height: calc(90vh - 120px); overflow-y: auto; padding-right: 10px;">
                <form id="driverForm" class="space-y-4">
                    <input type="hidden" id="driverId">
                    <div>
                        <label for="driverName" class="block font-medium">Name</label>
                        <input type="text" id="driverName" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="driverNickname" class="block font-medium">Nickname <span class="text-gray-500 text-sm">(Optional)</span></label>
                        <input type="text" id="driverNickname" class="w-full p-2 border rounded-md" placeholder="e.g., 'The Rocket'">
                    </div>
                    <div>
                        <label for="driverNumber" class="block font-medium">Driver Number</label>
                        <input type="text" id="driverNumber" class="w-full p-2 border rounded-md" required>
                        <p class="text-sm text-gray-500 mt-1">Must be unique within your class</p>
                    </div>
                     <div>
                        <label for="driverLicense" class="block font-medium">License Number</label>
                        <input type="text" id="driverLicense" class="w-full p-2 border rounded-md" required>
                    </div>
                     <div>
                        <label for="driverPhone" class="block font-medium">Phone Number</label>
                        <input type="tel" id="driverPhone" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="driverAddress" class="block font-medium">Address</label>
                        <input type="text" id="driverAddress" class="w-full p-2 border rounded-md" placeholder="Street Address">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="driverCity" class="block font-medium">City</label>
                            <input type="text" id="driverCity" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="driverState" class="block font-medium">State</label>
                            <input type="text" id="driverState" class="w-full p-2 border rounded-md" maxlength="2" placeholder="OH" style="text-transform: uppercase;">
                        </div>
                    </div>
                    <div>
                        <label for="driverClass" class="block font-medium">Class</label>
                        <select id="driverClass" class="w-full p-2 border rounded-md" required>
                           <option value="" disabled selected>Select a class...</option>
                           <!-- JS Populates -->
                        </select>
                    </div>
                    <div>
                        <label for="driverSponsors" class="block font-medium">Sponsors <span class="text-gray-500 text-sm">(Optional - for promoter sheet)</span></label>
                        <textarea id="driverSponsors" class="w-full p-2 border rounded-md" rows="2" placeholder="e.g., ABC Auto Parts, XYZ Racing"></textarea>
                    </div>
                    <div>
                        <label for="driverFunFacts" class="block font-medium">Fun Facts <span class="text-gray-500 text-sm">(Optional - for promoter announcements)</span></label>
                        <textarea id="driverFunFacts" class="w-full p-2 border rounded-md" rows="3" placeholder="e.g., Started racing in 2001, has won 9 track championships"></textarea>
                    </div>
                    <div class="flex justify-end gap-4 pt-4 sticky bottom-0 bg-white">
                        <button type="button" id="driverModalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">Save Driver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

     <div id="classModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="classModalTitle" class="text-xl font-bold mb-4">Edit Class</h3>
            <form id="classForm" class="space-y-4">
                <input type="hidden" id="classId">
                <div>
                    <label for="className" class="block font-medium">Class Name</label>
                    <input type="text" id="className" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="classModalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pointsModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="pointsModalTitle" class="text-xl font-bold mb-4">Edit Points</h3>
            <form id="pointsForm" class="space-y-4">
                <input type="hidden" id="pointsDriverId">
                <div>
                    <label for="newPoints" class="block font-medium">New Point Total</label>
                    <input type="number" id="newPoints" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="pointsModalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">Save Points</button>
                </div>
            </form>
        </div>
    </div>

    <div id="passwordModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="passwordModalTitle" class="text-xl font-bold mb-4">Administrator Password Required</h3>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label for="adminPassword" class="block font-medium">Password</label>
                    <input type="password" id="adminPassword" class="input-modern" required>
                    <p id="passwordError" class="text-red-500 text-sm mt-1 hidden">Incorrect password.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="passwordModalCancelBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- V4: Weekend Notes Modal -->
    <div id="weekendNotesModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="text-xl font-bold mb-4">Weekend Notes - <span id="weekendNotesDate"></span></h3>
            <p class="text-sm text-gray-600 mb-4">Document important information about this race weekend for your records. These notes will be saved with this event's history.</p>
            <form id="weekendNotesForm" class="space-y-4">
                <div>
                    <label for="weekendNotesText" class="block font-medium mb-2">Notes</label>
                    <textarea id="weekendNotesText" class="w-full p-3 border-2 rounded-md min-h-[200px]" placeholder="Example: Weather conditions, special announcements, attendance notes, track conditions, etc."></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="weekendNotesModalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Notes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- V4: Race History Modal -->
    <div id="raceHistoryModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h3 class="text-xl font-bold mb-4">üìö Race History</h3>
            <p class="text-sm text-gray-600 mb-4">Complete history of all finalized races with notes and results.</p>
            <div id="raceHistoryContent" class="space-y-4">
                <!-- History entries will be added here -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="raceHistoryModalCloseBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="payoutStructureModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="payoutStructureModalTitle" class="text-xl font-bold mb-4">Create Payout Structure</h3>
            <form id="payoutStructureForm" class="space-y-4">
                <input type="hidden" id="payoutStructureId">
                <div>
                    <label for="payoutStructureName" class="block font-semibold text-gray-700 mb-2">Structure Name</label>
                    <input type="text" id="payoutStructureName" placeholder="e.g., Weekly Feature, Special Event" class="input-modern" required>
                </div>
                <div>
                    <label class="block font-semibold text-gray-700 mb-2">Payout by Position</label>
                    <div class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2">
                        <div id="payoutPositionsContainer">
                            <!-- JS will generate position inputs -->
                        </div>
                    </div>
                </div>
                <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800">Total Purse:</span>
                        <span class="text-2xl font-bold text-orange-600">$<span id="modalTotalPurse">0</span></span>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="payoutStructureModalCancelBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Structure</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lineup Editor Modal -->
    <div id="lineupEditorModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 800px;">
            <h3 id="lineupEditorTitle" class="text-xl font-bold mb-4">Edit Lineup</h3>
            <input type="hidden" id="lineupEditorType">
            <input type="hidden" id="lineupEditorClassId">
            <input type="hidden" id="lineupEditorHeatIndex">
            
            <div class="space-y-4">
                <!-- Current Lineup -->
                <div>
                    <label class="block font-semibold text-gray-700 mb-2">Current Lineup</label>
                    <div id="currentLineupList" class="bg-gray-50 rounded-lg p-4 space-y-2 max-h-96 overflow-y-auto">
                        <!-- JS will populate -->
                    </div>
                </div>
                
                <!-- Add Driver Section -->
                <div class="border-t pt-4">
                    <label class="block font-semibold text-gray-700 mb-2">Add Driver to Lineup</label>
                    <div class="flex gap-2">
                        <select id="addDriverSelect" class="flex-1 p-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select a driver...</option>
                        </select>
                        <button type="button" id="addDriverToLineupBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">
                            Add
                        </button>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="lineupEditorCancelBtn" class="btn-secondary">Cancel</button>
                    <button type="button" id="lineupEditorSaveBtn" class="btn-primary">Save Lineup</button>
                </div>
            </div>
        </div>
    </div>

    <div id="driverPayoutModal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 800px;">
            <h3 id="driverPayoutModalTitle" class="text-xl font-bold mb-4">Driver Payout History</h3>
            <div id="driverPayoutDetails" class="space-y-4">
                <!-- JS will populate -->
            </div>
            <div class="flex justify-end gap-4 pt-4 border-t mt-6">
                <button type="button" id="driverPayoutModalCloseBtn" class="btn-primary">Close</button>
            </div>
        </div>
    </div>


    <script>
        // --- State Management ---
        const initialEventState = {
            registrations: {},
            completedRegistrations: [],
            heats: {},
            heatResults: {},
            bMains: {},
            bMainResults: {},
            features: {},
            featureResults: {},
            selectedPayoutStructure: null, // Payout structure ID for this event
            showUpPointsEnabled: true, // V3: Enable show-up points by default for each event
            suspendedClasses: {}, // V3: Track suspended races { classId: { status: 'suspended', suspendedAt: date, reason: string, savedState: {} } }
            weekendNotes: '', // V4: Notes about this race weekend for records
        };

        const initialGlobalState = {
            classes: [],
            drivers: [],
            seasonPoints: {},
            pointSettings: { heat: [], feature: [], showUpPoints: 0 }, // V3: Added showUpPoints
            payoutStructures: [], // Array of payout structure templates
            driverPayouts: {}, // Track payouts per driver { driverId: { yearlyTotal: 0, races: [] } }
            raceHistory: [], // V4: Track completed events with notes { date, classId, className, notes, heatResults, featureResults }
        };
        
        let state = { ...initialGlobalState, ...initialEventState };
        let _passwordProtectedAction = null;

        // --- Data Persistence ---
        // Helper function to remove duplicates from a lineup array
        function deduplicateLineup(lineup) {
            if (!Array.isArray(lineup)) return lineup;
            const uniqueLineup = [];
            const seen = new Set();
            lineup.forEach(driverId => {
                if (!seen.has(driverId)) {
                    uniqueLineup.push(driverId);
                    seen.add(driverId);
                }
            });
            return uniqueLineup;
        }
        
        // Clean up any existing duplicate data in state
        function cleanupDuplicateLineups() {
            let hadDuplicates = false;
            
            // Clean heats
            Object.keys(state.heats).forEach(classId => {
                if (state.heats[classId] && state.heats[classId].heats) {
                    state.heats[classId].heats = state.heats[classId].heats.map(heat => {
                        const cleanedHeat = deduplicateLineup(heat);
                        if (cleanedHeat.length !== heat.length) hadDuplicates = true;
                        return cleanedHeat;
                    });
                }
            });
            
            // Clean B-Mains
            Object.keys(state.bMains).forEach(classId => {
                if (state.bMains[classId] && state.bMains[classId].lineup) {
                    const originalLength = state.bMains[classId].lineup.length;
                    state.bMains[classId].lineup = deduplicateLineup(state.bMains[classId].lineup);
                    if (state.bMains[classId].lineup.length !== originalLength) hadDuplicates = true;
                }
            });
            
            // Clean Features
            Object.keys(state.features).forEach(classId => {
                if (state.features[classId] && state.features[classId].lineup) {
                    const originalLength = state.features[classId].lineup.length;
                    state.features[classId].lineup = deduplicateLineup(state.features[classId].lineup);
                    if (state.features[classId].lineup.length !== originalLength) hadDuplicates = true;
                }
            });
            
            if (hadDuplicates) {
                console.log('Cleaned up duplicate lineup data');
                saveState();
            }
            return hadDuplicates;
        }

        function loadState() {
            const allData = JSON.parse(localStorage.getItem('raceManagerData') || '{}');
            const eventId = `event_${document.getElementById('eventDate').value}`;

            // Load global data that persists across all events
            state.classes = allData.classes || [];
            state.drivers = allData.drivers || [];
            state.seasonPoints = allData.seasonPoints || {};
            state.pointSettings = allData.pointSettings || { heat: [], feature: [] };
            state.payoutStructures = allData.payoutStructures || [];
            state.driverPayouts = allData.driverPayouts || {};

            // Load data specific to the selected event
            const eventData = allData[eventId] || JSON.parse(JSON.stringify(initialEventState)); // Deep copy
            Object.assign(state, eventData);
            
            // CRITICAL FIX: Clean up any duplicate lineups in the loaded data
            cleanupDuplicateLineups();
            
            console.log(`Loaded data for event: ${eventId}`);
        }

        function saveState() {
            const allData = JSON.parse(localStorage.getItem('raceManagerData') || '{}');
            const eventId = `event_${document.getElementById('eventDate').value}`;

            // Prepare event-specific data to save
            const eventData = {};
            for (const key in initialEventState) {
                eventData[key] = state[key];
            }

            // Prepare global data to save
            const globalData = {};
            for (const key in initialGlobalState) {
                globalData[key] = state[key];
            }

            // Update the main data object
            allData[eventId] = eventData;
            Object.assign(allData, globalData);

            localStorage.setItem('raceManagerData', JSON.stringify(allData));
            console.log(`Saved data for event: ${eventId}`);
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // --- UI Logic ---
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(tabName).classList.add('active');

                     // Force render on tab switch for relevant tabs
                    if (tabName === 'heat-races') {
                        const select = document.getElementById('heatRacesClassSelect');
                        let classId = select.value;
                        // Auto-select first class if none selected
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1; // Skip the placeholder option
                            classId = select.value;
                        }
                        if (classId) renderHeatRaces(classId);
                    } else if (tabName === 'b-main') {
                        const select = document.getElementById('bMainClassSelect');
                        let classId = select.value;
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1;
                            classId = select.value;
                        }
                        if (classId) renderBMain(classId);
                    } else if (tabName === 'feature') {
                        const select = document.getElementById('featureClassSelect');
                        let classId = select.value;
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1;
                            classId = select.value;
                        }
                        if (classId) renderFeature(classId);
                    } else if (tabName === 'race-results') {
                        const select = document.getElementById('raceResultsClassSelect');
                        let classId = select.value;
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1;
                            classId = select.value;
                        }
                        if(classId) renderRaceResults(classId);
                    } else if (tabName === 'points') {
                        const select = document.getElementById('pointsClassSelect');
                        let classId = select.value;
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1;
                            classId = select.value;
                        }
                        if(classId) renderPointsPage(classId);
                    } else if (tabName === 'payouts') {
                        renderPayouts();
                    } else if (tabName === 'history') {
                        const select = document.getElementById('historyClassSelect');
                        let classId = select.value;
                        if (!classId && select.options.length > 1) {
                            select.selectedIndex = 1;
                            classId = select.value;
                        }
                        renderHistoryDates(classId);
                    }
                });
            });
        }
        
        function switchTab(tabName) {
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).click();
        }

        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        // --- Modal Helpers ---
        function showInfoModal(title, message) {
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            const inputContainer = document.getElementById('confirmationInputContainer');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            confirmBtn.textContent = 'OK';
            confirmBtn.className = 'bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700';
            cancelBtn.classList.add('hidden');
            inputContainer.classList.add('hidden');

            showModal('confirmationModal');

            confirmBtn.onclick = () => {
                hideModal('confirmationModal');
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = 'Confirm';
                confirmBtn.className = 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700';
                confirmBtn.onclick = null;
            };
        }

        function showConfirmationModal(title, message, onConfirmCallback) {
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            const inputContainer = document.getElementById('confirmationInputContainer');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            confirmBtn.textContent = 'Confirm';
            confirmBtn.className = 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700';
            cancelBtn.classList.remove('hidden');
            inputContainer.classList.add('hidden');

            showModal('confirmationModal');

            const cleanup = () => {
                hideModal('confirmationModal');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
            };

            confirmBtn.onclick = () => {
                onConfirmCallback();
                cleanup();
            };

            cancelBtn.onclick = cleanup;
        }

        // --- Rendering Functions ---
        
        function renderAll() {
            renderClasses();
            renderDrivers();
            renderRaceSetupClasses();
            renderHeatRacesClasses();
            renderNextRaceClasses('bMain');
            renderNextRaceClasses('feature');
            updatePayoutStructureDropdown();
            
            const activeTab = document.querySelector('.tab-content.active').id;
            const selectMap = {
                'registration': 'registrationClassSelect',
                'heat-races': 'heatRacesClassSelect',
                'b-main': 'bMainClassSelect',
                'feature': 'featureClassSelect',
                'race-results': 'raceResultsClassSelect',
                'points': 'pointsClassSelect',
                'history': 'historyClassSelect',
            };
            const renderMap = {
                'registration': renderRegistrationForClass,
                'heat-races': renderHeatRaces,
                'b-main': renderBMain,
                'feature': renderFeature,
                'race-results': renderRaceResults,
                'points': renderPointsPage,
                'history': renderHistoryDates,
            };

            if (selectMap[activeTab] && renderMap[activeTab]) {
                const selectId = selectMap[activeTab];
                const renderFn = renderMap[activeTab];
                const classId = document.getElementById(selectId).value;
                if(classId) renderFn(classId);
            }
        }

        function renderClasses() {
             const classList = document.getElementById('classList');
             const classFilters = [
                 document.getElementById('driverClassFilter'), 
                 document.getElementById('driverClass'), 
                 document.getElementById('registrationClassSelect'),
                 document.getElementById('pointsClassSelect'),
                 document.getElementById('raceResultsClassSelect'),
                 document.getElementById('raceSetupClassSelect'),
                 document.getElementById('heatRacesClassSelect'),
                 document.getElementById('bMainClassSelect'),
                 document.getElementById('featureClassSelect'),
                 document.getElementById('historyClassSelect'),
                 document.getElementById('payoutClassFilter'),
             ];

             const selectedValues = {}; 
             classFilters.forEach(filter => { 
                 if (filter) selectedValues[filter.id] = filter.value;
             });

             classList.innerHTML = '';
             classFilters.forEach(filter => {
                 if (!filter) return;
                 const firstOption = filter.options[0];
                 filter.innerHTML = ''; 
                 if (firstOption) { filter.appendChild(firstOption); }
             });
             
             const completedIds = new Set(state.completedRegistrations.map(c => c.id));

             state.classes.sort((a,b) => a.name.localeCompare(b.name)).forEach(cls => {
                 const li = document.createElement('li');
                 li.className = 'p-3 bg-gray-50 rounded-md flex justify-between items-center';
                 li.innerHTML = `<span>${cls.name}</span> <div><button class="text-sm text-orange-500 mr-2 edit-class-btn" data-id="${cls.id}">Edit</button><button class="text-sm text-red-500 delete-class-btn" data-id="${cls.id}">Delete</button></div>`;
                 classList.appendChild(li);
                 
                 classFilters.forEach(filter => {
                     if (!filter) return;
                     const option = document.createElement('option');
                     option.value = cls.id;
                     const isCompleted = completedIds.has(cls.id);
                     if (filter.id === 'registrationClassSelect') {
                       option.textContent = `${cls.name} ${isCompleted ? '‚úì' : ''}`;
                        option.dataset.completed = isCompleted;
                     } else {
                        option.textContent = cls.name;
                     }
                     filter.appendChild(option);
                 });
             });

            classFilters.forEach(filter => { 
                 if (filter && selectedValues[filter.id]) {
                     filter.value = selectedValues[filter.id];
                 }
             });
        }
        
        function renderDrivers() {
            const driverList = document.getElementById('driverList');
            driverList.innerHTML = '';
            const filterValue = document.getElementById('driverClassFilter').value;
            let driversToRender = [...state.drivers];

            if (filterValue) {
                driversToRender = driversToRender.filter(d => d.classId === filterValue);
            }

            driversToRender.sort((a, b) => a.name.localeCompare(b.name));

            driversToRender.forEach(driver => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.dataset.driverId = driver.id;
                tr.innerHTML = `
                    <td class="p-2">${driver.name}</td>
                    <td class="p-2">${driver.number}</td>
                    <td class="p-2">${driver.license}</td>
                    <td class="p-2">
                        <button class="text-sm text-orange-500 mr-2 edit-driver-btn">Edit</button>
                        <button class="text-sm text-red-500 delete-driver-btn">Delete</button>
                    </td>
                `;
                driverList.appendChild(tr);
            });
        }
        
        function renderRaceSetupClasses() {
            const raceSetupSelect = document.getElementById('raceSetupClassSelect');
            const selectedValue = raceSetupSelect.value;
            const firstOption = raceSetupSelect.options[0];
            raceSetupSelect.innerHTML = '';
            if(firstOption) raceSetupSelect.appendChild(firstOption);

            const registeredClasses = state.completedRegistrations.filter(reg => reg.registrationCompleted);
            
            registeredClasses.sort((a,b) => a.className.localeCompare(b.className)).forEach(reg => {
                const option = document.createElement('option');
                option.value = reg.id;
                option.textContent = `${reg.className} ${reg.heatsGenerated ? '‚úì' : ''}`;
                raceSetupSelect.appendChild(option);
            });
            raceSetupSelect.value = selectedValue;
        }

        function renderRegistrationForClass(selectedClassId) {
            const availableDriversContainer = document.getElementById('availableDrivers');
            const registeredDriversContainer = document.getElementById('registeredDrivers');
            availableDriversContainer.innerHTML = '';
            registeredDriversContainer.innerHTML = '';

            const isCompleted = state.completedRegistrations.some(c => c.id === selectedClassId);

            if (!selectedClassId) {
                availableDriversContainer.innerHTML = '<p class="text-gray-500">Select a class to see available drivers.</p>';
                registeredDriversContainer.innerHTML = '<p class="text-gray-500">Registered drivers for the selected class will appear here.</p>';
                return;
            }

            const allDriversInClass = state.drivers.filter(d => d.classId === selectedClassId);
            const registeredDriverIds = new Set(state.registrations[selectedClassId]?.driverIds || []);

            allDriversInClass.sort((a,b) => a.name.localeCompare(b.name));

            let availableCount = 0;
            let registeredCount = 0;

            allDriversInClass.forEach(driver => {
                const driverEl = document.createElement('div');
                driverEl.className = 'driver-item';
                driverEl.textContent = `${driver.number} - ${driver.name}`;
                driverEl.dataset.driverId = driver.id;
                driverEl.dataset.classId = selectedClassId;

                if (!isCompleted) {
                    if (registeredDriverIds.has(driver.id)) {
                        driverEl.addEventListener('click', unregisterDriver);
                        registeredDriversContainer.appendChild(driverEl);
                        registeredCount++;
                    } else {
                        driverEl.addEventListener('click', registerDriver);
                        availableDriversContainer.appendChild(driverEl);
                        availableCount++;
                    }
                } else {
                     if (registeredDriverIds.has(driver.id)) {
                        driverEl.style.cursor = 'default';
                        registeredDriversContainer.appendChild(driverEl);
                        registeredCount++;
                    } else {
                        driverEl.style.cursor = 'default';
                        availableDriversContainer.appendChild(driverEl);
                        availableCount++;
                    }
                }
            });

             if (availableCount === 0) {
                 availableDriversContainer.innerHTML = '<p class="text-gray-500">No available drivers for this class.</p>';
             }
             if (registeredCount === 0) {
                 registeredDriversContainer.innerHTML = '<p class="text-gray-500">No drivers registered yet.</p>';
             }
        }
        
        function renderRaceSetupLineup(selectedClassId) {
            const lineupList = document.getElementById('lineupSetupList');
            lineupList.innerHTML = '';

            if (!selectedClassId) {
                lineupList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Select a class to see registered drivers.</td></tr>';
                return;
            }

            const completedReg = state.completedRegistrations.find(reg => reg.id === selectedClassId);
            if (!completedReg || !completedReg.registeredDrivers) {
                lineupList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No registration data found for this class.</td></tr>';
                return;
            }
            
            const driverDetails = completedReg.registeredDrivers
                .map(driverId => state.drivers.find(d => d.id === driverId))
                .filter(Boolean); 

            if (driverDetails.length === 0) {
                 lineupList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No drivers are registered for this class.</td></tr>';
                 return;
            }

            driverDetails.sort((a, b) => a.name.localeCompare(b.name));
            
            driverDetails.forEach(driver => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.dataset.driverId = driver.id;
                tr.innerHTML = `
                    <td class="p-2">${driver.name}</td>
                    <td class="p-2">${driver.number}</td>
                    <td class="p-2">
                        <input type="text" class="p-1 border rounded-md w-full" placeholder="Pill # / Time">
                    </td>
                `;
                lineupList.appendChild(tr);
            });
        }
        
        function renderHeatRacesClasses() {
            const heatRacesSelect = document.getElementById('heatRacesClassSelect');
            const selectedValue = heatRacesSelect.value;
            const firstOption = heatRacesSelect.options[0];
            heatRacesSelect.innerHTML = '';
            if(firstOption) heatRacesSelect.appendChild(firstOption);

            const classesWithHeats = Object.keys(state.heats).map(classId => {
                return state.classes.find(c => c.id === classId);
            }).filter(Boolean);
            
            classesWithHeats.sort((a,b) => a.name.localeCompare(b.name)).forEach(cls => {
                // Check if heats have been FINALIZED (B-Main or Feature lineup exists)
                const heatsFinalized = !!(state.bMains[cls.id] || state.features[cls.id]);

                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.name} ${heatsFinalized ? '‚úì' : ''}`;
                heatRacesSelect.appendChild(option);
            });
            heatRacesSelect.value = selectedValue;
        }

        function handleFinishPositionChange(event) {
            const changedSelect = event.target;
            const container = changedSelect.closest('.bg-gray-50');
            if (!container) return;
            const allSelectsInRace = container.querySelectorAll('.result-select');

            const selectedValues = new Set();
            allSelectsInRace.forEach(s => {
                if (s.value) {
                    selectedValues.add(s.value);
                }
            });

            allSelectsInRace.forEach(select => {
                for (const option of select.options) {
                    if (option.value) { 
                        option.disabled = selectedValues.has(option.value) && select.value !== option.value;
                    }
                }
            });
        }

        function renderHeatRaces(classId) {
            const container = document.getElementById('heatLineupsContainer');
            const finalizeBtn = document.getElementById('finalizeHeatsBtn');
            const resetBtn = document.getElementById('resetToRegistrationBtn'); // V4: Reset button
            container.innerHTML = '';
            finalizeBtn.classList.add('hidden');
            resetBtn.classList.add('hidden'); // V4: Hide by default

            if (!classId || !state.heats[classId] || !state.heats[classId].heats) {
                container.innerHTML = '<p class="text-gray-500 text-center">Select a class to see heat lineups.</p>';
                return;
            }
            
            // V4: Show reset button if heats exist and race not yet finalized
            const classStatus = state.completedRegistrations.find(c => c.id === classId);
            const hasHeats = state.heats[classId] && state.heats[classId].heats && state.heats[classId].heats.length > 0;
            const isFinalized = classStatus && classStatus.raceCompleted;
            
            if (hasHeats && !isFinalized) {
                resetBtn.classList.remove('hidden');
                resetBtn.dataset.classId = classId; // Store classId for the handler
            }

            const heatLineups = state.heats[classId].heats;
            const savedResultsForClass = state.heatResults[classId] || {};
            let allHeatsSavedOrRainout = true;

            heatLineups.forEach((heat, index) => {
                const heatContainer = document.createElement('div');
                heatContainer.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                heatContainer.dataset.heatIndex = index;

                const savedResultsForHeat = savedResultsForClass[`heat_${index}`];
                const isRainout = savedResultsForHeat === 'rainout';
                if (!savedResultsForHeat) allHeatsSavedOrRainout = false;

                const titleHtml = `
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-xl font-semibold">Heat ${index + 1} ${isRainout ? '<span class="text-red-500 text-sm">(RAINOUT)</span>' : ''}</h3>
                         <div class="flex gap-2">
                             ${!savedResultsForHeat ? `<button class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 edit-lineup-btn" data-heat-index="${index}">Edit Lineup</button>` : ''}
                             ${!savedResultsForHeat ? `<button class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 no-results-btn">No Results</button>` : ''}
                         </div>
                    </div>`;
                heatContainer.innerHTML = titleHtml;

                // V3: Use new results entry system
                const driversInHeat = heat.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
                const v3ResultsEntry = createV3ResultsEntry(
                    driversInHeat,
                    savedResultsForHeat,
                    'heat',
                    `heat-${classId}-${index}`
                );
                heatContainer.appendChild(v3ResultsEntry);
                
                const saveButton = document.createElement('button');
                saveButton.className = 'mt-4 bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 float-right save-heat-btn';
                saveButton.textContent = `Save Heat ${index + 1} Results`;
                saveButton.dataset.heatIndex = index;
                saveButton.dataset.classId = classId;
                
                if (savedResultsForHeat) {
                    saveButton.textContent = 'Results Saved!';
                    saveButton.disabled = true;
                    saveButton.classList.replace('bg-orange-600', 'bg-green-600');
                    saveButton.classList.remove('hover:bg-orange-700');
                }
                
                if (!isRainout) {
                    heatContainer.appendChild(saveButton);
                }

                container.appendChild(heatContainer);
            });

            if (allHeatsSavedOrRainout && heatLineups.length > 0) {
                 finalizeBtn.classList.remove('hidden');
            }
        }
        
        function renderNextRaceClasses(raceType) {
            const selectEl = document.getElementById(`${raceType}ClassSelect`);
            const selectedValue = selectEl.value;
            const firstOption = selectEl.options[0];
            selectEl.innerHTML = '';
            if(firstOption) selectEl.appendChild(firstOption);

            const stateKey = raceType === 'bMain' ? 'bMains' : 'features';
            const resultsKey = raceType === 'bMain' ? 'bMainResults' : 'featureResults';
            
            const classesWithLineups = Object.keys(state[stateKey]).map(classId => {
                return state.classes.find(c => c.id === classId);
            }).filter(Boolean);

            classesWithLineups.sort((a,b) => a.name.localeCompare(b.name)).forEach(cls => {
                const isComplete = raceType === 'feature' 
                    ? (state.completedRegistrations.find(c => c.id === cls.id)?.raceCompleted || false)
                    : !!state[resultsKey][cls.id];

                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.name} ${isComplete ? '‚úì' : ''}`;
                selectEl.appendChild(option);
            });
            selectEl.value = selectedValue;
        }
        
       function renderBMain(classId) {
            const container = document.getElementById('bMainContainer');
            const finalizeBtn = document.getElementById('finalizeBMainBtn');
            container.innerHTML = '';
            finalizeBtn.classList.add('hidden');

            const raceData = state.bMains[classId];
            if(!classId || !raceData || !raceData.lineup || raceData.lineup.length === 0) {
                 container.innerHTML = `<p class="text-gray-500 text-center">No B-Main lineup for this class.</p>`;
                 return;
            }

            const raceContainer = document.createElement('div');
            raceContainer.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
            
            const savedResults = state.bMainResults[classId];
            const isRainout = savedResults && savedResults.results === 'rainout';

            const titleHtml = `
                <div class="flex justify-between items-center mb-3">
                     <h3 class="text-xl font-semibold">B-Main Lineup ${isRainout ? '<span class="text-red-500 text-sm">(RAINOUT)</span>' : ''}</h3>
                     <div class="flex gap-2">
                         ${!savedResults ? `<button class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 edit-lineup-btn" data-race-type="bMain">Edit Lineup</button>` : ''}
                         ${!savedResults ? `<button class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 no-results-btn" data-race-type="bMain">Declare No Results</button>` : ''}
                     </div>
                </div>`;
            raceContainer.innerHTML = titleHtml;
            
            // V3: Use new results entry system
            const driversInBMain = raceData.lineup.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
            const v3ResultsEntry = createV3ResultsEntry(
                driversInBMain,
                savedResults ? savedResults.results : null,
                'bmain',
                `bmain-${classId}`
            );
            raceContainer.appendChild(v3ResultsEntry);
            
            const saveButton = document.createElement('button');
            saveButton.className = 'mt-4 bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 float-right save-bmain-btn';
            saveButton.textContent = 'Save B-Main Results';
            saveButton.dataset.classId = classId;
            
            if (savedResults) {
                saveButton.textContent = 'Results Saved!';
                saveButton.disabled = true;
                saveButton.classList.replace('bg-orange-600', 'bg-green-600');
                saveButton.classList.remove('hover:bg-orange-700');
                if (!isRainout) finalizeBtn.classList.remove('hidden');
            }
            
            if (!isRainout) {
                 raceContainer.appendChild(saveButton);
            }
            
            container.appendChild(raceContainer);
       }

        // V3: NEW RESULTS ENTRY SYSTEM
        // Creates modern results entry interface with text inputs and real-time validation
        function createV3ResultsEntry(drivers, savedResults, raceType, raceIdentifier, requireTechInspection = false, classId = null) {
            const container = document.createElement('div');
            container.className = 'v3-results-entry';
            
            const isRainout = savedResults === 'rainout';
            const resultsArray = Array.isArray(savedResults) ? savedResults : null;
            const isSaved = resultsArray !== null || isRainout;
            
            // V4: For features that aren't saved, check if tech inspection checkbox is checked
            let techInspectionComplete = true;
            if (raceType === 'feature' && !isSaved) {
                // Check if the checkbox exists and is checked in the DOM
                const checkbox = classId ? document.getElementById(`techInspection-${classId}`) : null;
                techInspectionComplete = checkbox ? checkbox.checked : false;
            }
            
            // Create two-column layout
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Position Inputs -->
                    <div class="bg-white p-4 rounded-lg border-2 border-gray-200">
                        <h4 class="font-bold text-lg mb-4 text-gray-700">Enter Finishing Positions</h4>
                        ${!techInspectionComplete && raceType === 'feature' ? '<p class="text-red-600 font-semibold mb-3">‚ö†Ô∏è Complete tech inspection before entering results</p>' : ''}
                        <div id="v3-positions-${raceIdentifier}" class="space-y-2">
                            <!-- Positions will be added here -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Available Drivers -->
                    <div class="bg-white p-4 rounded-lg border-2 border-gray-200">
                        <h4 class="font-bold text-lg mb-4 text-gray-700">Available Drivers</h4>
                        <div id="v3-drivers-${raceIdentifier}" class="space-y-2">
                            <!-- Drivers will be added here -->
                        </div>
                    </div>
                </div>
            `;
            
            const positionsContainer = container.querySelector(`#v3-positions-${raceIdentifier}`);
            const driversContainer = container.querySelector(`#v3-drivers-${raceIdentifier}`);
            
            // Build map of car numbers to driver info
            const driverMap = {};
            drivers.forEach(driver => {
                driverMap[driver.number] = {
                    id: driver.id,
                    name: driver.name,
                    number: driver.number
                };
            });
            
            // Create position inputs
            const positionInputs = {};
            for (let i = 1; i <= drivers.length; i++) {
                const posDiv = document.createElement('div');
                posDiv.className = 'flex items-center gap-3';
                posDiv.innerHTML = `
                    <label class="w-20 font-semibold text-gray-700">Position ${i}:</label>
                    <input type="text" 
                           class="v3-position-input flex-1 p-2 border-2 rounded-md font-mono text-lg"
                           data-position="${i}"
                           data-race-id="${raceIdentifier}"
                           placeholder="Car #"
                           ${isSaved || !techInspectionComplete ? 'disabled' : ''}>
                    <span class="v3-status-icon w-6 h-6"></span>
                `;
                positionsContainer.appendChild(posDiv);
                const input = posDiv.querySelector('input');
                positionInputs[i] = input;
                
                // Pre-fill if results exist
                if (resultsArray) {
                    const result = resultsArray.find(r => r.position === i);
                    if (result) {
                        const driver = drivers.find(d => d.id === result.driverId);
                        if (driver) {
                            input.value = driver.number;
                            input.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                        }
                    }
                }
            }
            
            // Create driver list
            drivers.forEach((driver, index) => {
                const driverDiv = document.createElement('div');
                driverDiv.className = 'v3-driver-item p-3 rounded-md border-2 transition-all';
                driverDiv.dataset.carNumber = driver.number;
                driverDiv.dataset.driverId = driver.id;
                driverDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-xl">#${driver.number}</span>
                        <span class="font-medium">${driver.name}</span>
                        <span class="text-sm text-gray-500 ml-auto">(Start: ${index + 1})</span>
                    </div>
                `;
                
                // Check if this driver is already entered
                if (resultsArray) {
                    const isEntered = resultsArray.some(r => r.driverId === driver.id);
                    if (isEntered) {
                        driverDiv.classList.add('bg-gray-200', 'border-gray-400', 'text-gray-500');
                    } else {
                        driverDiv.classList.add('bg-orange-50', 'border-orange-400', 'text-orange-900');
                    }
                } else {
                    driverDiv.classList.add('bg-orange-50', 'border-orange-400', 'text-orange-900');
                }
                
                driversContainer.appendChild(driverDiv);
            });
            
            // V3: Real-time validation on input
            if (!isSaved) {
                Object.values(positionInputs).forEach(input => {
                    input.addEventListener('input', (e) => {
                        validateV3PositionInput(e.target, driverMap, raceIdentifier);
                    });
                });
            }
            
            return container;
        }
        
        // V3: Validate position input in real-time
        function validateV3PositionInput(input, driverMap, raceIdentifier) {
            const carNumber = input.value.trim();
            const statusIcon = input.parentElement.querySelector('.v3-status-icon');
            
            // Clear previous state
            input.classList.remove('border-green-500', 'bg-green-50', 'text-green-700',
                                   'border-red-500', 'bg-red-50', 'text-red-700',
                                   'border-gray-300', 'bg-white');
            statusIcon.innerHTML = '';
            
            if (carNumber === '') {
                // Empty - neutral state
                input.classList.add('border-gray-300', 'bg-white');
                updateV3DriverList(raceIdentifier);
                return;
            }
            
            // Check if this car number exists in this race
            if (!driverMap[carNumber]) {
                // Invalid car number - RED
                input.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                statusIcon.innerHTML = '√¢¬ù≈í';
                input.dataset.valid = 'false';
                updateV3DriverList(raceIdentifier);
                return;
            }
            
            // Check for duplicates
            const allInputs = document.querySelectorAll(`input[data-race-id="${raceIdentifier}"]`);
            const usedNumbers = Array.from(allInputs)
                .filter(inp => inp !== input && inp.value.trim())
                .map(inp => inp.value.trim());
            
            if (usedNumbers.includes(carNumber)) {
                // Duplicate - RED
                input.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                statusIcon.innerHTML = '√¢¬ù≈í';
                input.dataset.valid = 'false';
                updateV3DriverList(raceIdentifier);
                return;
            }
            
            // Valid - GREEN
            input.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
            statusIcon.innerHTML = '√¢≈ì‚Äú';
            input.dataset.valid = 'true';
            updateV3DriverList(raceIdentifier);
        }
        
        // V3: Update driver list colors based on what's entered
        function updateV3DriverList(raceIdentifier) {
            const allInputs = document.querySelectorAll(`input[data-race-id="${raceIdentifier}"]`);
            const enteredNumbers = Array.from(allInputs)
                .filter(inp => inp.value.trim() && inp.dataset.valid === 'true')
                .map(inp => inp.value.trim());
            
            const driverItems = document.querySelectorAll(`#v3-drivers-${raceIdentifier} .v3-driver-item`);
            driverItems.forEach(item => {
                const carNumber = item.dataset.carNumber;
                
                // Clear previous classes
                item.classList.remove('bg-orange-50', 'border-orange-400', 'text-orange-900',
                                     'bg-gray-200', 'border-gray-400', 'text-gray-500');
                
                if (enteredNumbers.includes(carNumber)) {
                    // Driver entered - GREY
                    item.classList.add('bg-gray-200', 'border-gray-400', 'text-gray-500');
                } else {
                    // Driver not entered - ORANGE
                    item.classList.add('bg-orange-50', 'border-orange-400', 'text-orange-900');
                }
            });
        }
        
        // V3: Get results from V3 entry form
        function getV3Results(raceIdentifier, drivers) {
            const allInputs = document.querySelectorAll(`input[data-race-id="${raceIdentifier}"]`);
            const results = [];
            
            // Build driver map
            const driverMap = {};
            drivers.forEach(driver => {
                driverMap[driver.number] = driver.id;
            });
            
            for (const input of allInputs) {
                const carNumber = input.value.trim();
                const position = parseInt(input.dataset.position);
                
                if (!carNumber) {
                    return { valid: false, error: `Please enter a car number for position ${position}` };
                }
                
                if (input.dataset.valid !== 'true') {
                    return { valid: false, error: `Invalid or duplicate car number at position ${position}` };
                }
                
                const driverId = driverMap[carNumber];
                results.push({ driverId, position });
            }
            
            return { valid: true, results };
        }

       function renderFeature(classId) {
            const container = document.getElementById('featureContainer');
            const finalizeBtn = document.getElementById('finalizeFeatureBtn');
            const invertControls = document.getElementById('featureInvertControls');
            container.innerHTML = '';
            finalizeBtn.classList.add('hidden');
            invertControls.classList.add('hidden');
            
            const raceData = state.features[classId];
            if(!classId || !raceData || !raceData.lineup) {
                 container.innerHTML = `<p class="text-gray-500 text-center">Select a class to see Feature lineup.</p>`;
                 return;
            }

            if (!raceData.invert) {
                raceData.invert = '0';
            }
            
            // V3: Handle custom invert radio button selection
            const invertValue = raceData.invert;
            const customInput = document.getElementById('customInvertNum');
            const standardValues = ['0', '4', '6', '8', 'full'];
            
            if (standardValues.includes(invertValue)) {
                document.querySelector(`input[name="invertOption"][value="${invertValue}"]`).checked = true;
                customInput.style.display = 'none';
                customInput.classList.add('hidden');
            } else {
                // Custom numeric value
                document.querySelector(`input[name="invertOption"][value="custom"]`).checked = true;
                customInput.style.display = 'inline-block';
                customInput.classList.remove('hidden');
                customInput.value = invertValue;
            }

            invertControls.classList.remove('hidden');
            let displayLineup = [...raceData.lineup];

            if (invertValue !== '0') {
                if (invertValue === 'full') {
                    displayLineup.reverse();
                } else {
                    const numToInvert = parseInt(invertValue);
                    const top = displayLineup.slice(0, numToInvert).reverse();
                    const rest = displayLineup.slice(numToInvert);
                    displayLineup = [...top, ...rest];
                }
            }

            const raceContainer = document.createElement('div');
            raceContainer.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
            
            const savedResults = state.featureResults[classId];
            const isRainout = savedResults && savedResults.results === 'rainout';

            const titleHtml = `
                <div class="flex justify-between items-center mb-3">
                     <h3 class="text-xl font-semibold">Feature Lineup & Results ${isRainout ? '<span class="text-red-500 text-sm">(RAINOUT)</span>' : ''}</h3>
                     <div class="flex gap-2">
                         ${!savedResults ? `<button class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 edit-lineup-btn" data-race-type="feature">Edit Lineup</button>` : ''}
                         ${!savedResults ? `<button class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 no-results-btn" data-race-type="feature">Declare No Results</button>` : ''}
                     </div>
                </div>`;
            raceContainer.innerHTML = titleHtml;
            
            // V4: Tech Inspection Checkbox - required before entering results
            const techInspectionDiv = document.createElement('div');
            techInspectionDiv.className = 'bg-yellow-50 border-2 border-yellow-400 p-4 rounded-lg mb-4';
            techInspectionDiv.innerHTML = `
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="techInspection-${classId}" 
                           class="w-5 h-5 text-orange-600 focus:ring-orange-500 rounded"
                           ${savedResults ? 'checked disabled' : ''}>
                    <span class="text-lg font-semibold ${savedResults ? 'text-gray-600' : 'text-gray-900'}">
                        ‚úÖ Tech Inspection Complete
                        ${!savedResults ? '<span class="text-sm text-red-600 ml-2">(Required before entering results)</span>' : ''}
                    </span>
                </label>
            `;
            raceContainer.appendChild(techInspectionDiv);
            
            // V3: Use new results entry system
            const driversInLineup = displayLineup.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
            const v3ResultsEntry = createV3ResultsEntry(
                driversInLineup,
                savedResults ? savedResults.results : null,
                'feature',
                `feature-${classId}`,
                savedResults ? false : true, // V4: Disable results until tech inspection checked
                classId // V4: Pass classId for tech inspection validation
            );
            raceContainer.appendChild(v3ResultsEntry);
            
            const saveButton = document.createElement('button');
            saveButton.className = 'mt-4 bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 float-right save-feature-btn';
            saveButton.textContent = 'Save Feature Results';
            saveButton.dataset.classId = classId;

            if (savedResults) {
                saveButton.textContent = 'Results Saved!';
                saveButton.disabled = true;
                saveButton.classList.replace('bg-orange-600', 'bg-green-600');
                saveButton.classList.remove('hover:bg-orange-700');
                if (!isRainout) finalizeBtn.classList.remove('hidden');
            }
            
            if (!isRainout) {
                raceContainer.appendChild(saveButton);
            }

            container.appendChild(raceContainer);
       }
        
        function renderPointSettings() {
            // V3: Load show-up points value
            document.getElementById('showUpPoints').value = state.pointSettings.showUpPoints || 0;
            
            const heatContainer = document.getElementById('heatPointsContainer');
            const featureContainer = document.getElementById('featurePointsContainer');
            heatContainer.innerHTML = '';
            featureContainer.innerHTML = '';

            for (let i = 1; i <= 30; i++) {
                const heatValue = state.pointSettings.heat[i-1] || 0;
                const featureValue = state.pointSettings.feature[i-1] || 0;

                heatContainer.innerHTML += `
                    <div class="grid grid-cols-3 items-center gap-2">
                        <label class="font-medium text-right">Position ${i}:</label>
                        <input type="number" value="${heatValue}" class="col-span-2 p-1 border rounded-md" data-pos="${i}">
                    </div>
                `;
                featureContainer.innerHTML += `
                    <div class="grid grid-cols-3 items-center gap-2">
                        <label class="font-medium text-right">Position ${i}:</label>
                        <input type="number" value="${featureValue}" class="col-span-2 p-1 border rounded-md" data-pos="${i}">
                    </div>
                `;
            }
        }
        
        function renderPointsPage(classId) {
            const pointsList = document.getElementById('pointsList');
            pointsList.innerHTML = '';
            if (!classId) {
                pointsList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">Select a class to view points.</td></tr>';
                return;
            }

            const driversInClass = state.drivers.filter(d => d.classId === classId);
            const driverPointsData = driversInClass.map(driver => {
                const pointsData = state.seasonPoints[driver.id] || {
                    points: 0, starts: 0, featureWins: 0, heatWins: 0, top5s: 0, top10s: 0
                };
                return { ...driver, ...pointsData };
            });

            driverPointsData.sort((a,b) => b.points - a.points);
            
            if(driverPointsData.length === 0) {
                 pointsList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">No drivers or points data for this class.</td></tr>';
                return;
            }

            driverPointsData.forEach((driver, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.dataset.driverId = driver.id;
                tr.innerHTML = `
                    <td class="p-2 font-bold">${index + 1}</td>
                    <td class="p-2">${driver.name} (${driver.number})</td>
                    <td class="p-2">${driver.points}</td>
                    <td class="p-2">${driver.starts}</td>
                    <td class="p-2">${driver.featureWins}</td>
                    <td class="p-2">${driver.heatWins}</td>
                    <td class="p-2">${driver.top5s}</td>
                    <td class="p-2">${driver.top10s}</td>
                    <td class="p-2"><button class="text-sm text-orange-500 edit-points-btn">Edit</button></td>
                `;
                pointsList.appendChild(tr);
            });
        }
        
        // V4: Render Payouts Management Page
        function renderPayouts() {
            const payoutsList = document.getElementById('payoutsList');
            const totalYearlyEl = document.getElementById('totalYearlyPayout');
            const totalEventsEl = document.getElementById('totalEventsWithPayouts');
            const avgPayoutEl = document.getElementById('avgPayoutPerEvent');
            const classFilter = document.getElementById('payoutClassFilter');
            const searchInput = document.getElementById('payoutDriverSearch');
            
            if (!state.driverPayouts || Object.keys(state.driverPayouts).length === 0) {
                payoutsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">No payout data yet. Finalize some races with payout structures to track earnings!</td></tr>';
                totalYearlyEl.textContent = '$0';
                totalEventsEl.textContent = '0';
                avgPayoutEl.textContent = '$0';
                return;
            }
            
            // Calculate summary stats
            let totalPaid = 0;
            const eventDates = new Set();
            
            Object.values(state.driverPayouts).forEach(driverData => {
                totalPaid += driverData.yearlyTotal || 0;
                driverData.races.forEach(race => {
                    eventDates.add(race.date);
                });
            });
            
            const numEvents = eventDates.size;
            const avgPayout = numEvents > 0 ? totalPaid / numEvents : 0;
            
            totalYearlyEl.textContent = '$' + totalPaid.toFixed(2);
            totalEventsEl.textContent = numEvents.toString();
            avgPayoutEl.textContent = '$' + avgPayout.toFixed(2);
            
            // Build driver rows
            const filterClass = classFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            
            const driverRows = [];
            Object.entries(state.driverPayouts).forEach(([driverId, payoutData]) => {
                const driver = state.drivers.find(d => d.id === driverId);
                if (!driver) return;
                
                const className = state.classes.find(c => c.id === driver.classId)?.name || 'Unknown';
                
                // Apply filters
                if (filterClass && driver.classId !== filterClass) return;
                if (searchTerm && !driver.name.toLowerCase().includes(searchTerm) && 
                    !driver.number.toString().includes(searchTerm)) return;
                
                driverRows.push({
                    driver: driver,
                    className: className,
                    total: payoutData.yearlyTotal || 0,
                    events: payoutData.races.length
                });
            });
            
            // Sort by total winnings descending
            driverRows.sort((a, b) => b.total - a.total);
            
            if (driverRows.length === 0) {
                payoutsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">No drivers match the current filters.</td></tr>';
                return;
            }
            
            // Render rows
            const html = driverRows.map((row, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td class="p-3">
                        <div class="font-semibold text-gray-900">${row.driver.name}</div>
                        <div class="text-xs text-gray-500">${row.driver.city || ''} ${row.driver.state || ''}</div>
                    </td>
                    <td class="p-3">
                        <span class="inline-block bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold text-sm">
                            #${row.driver.number}
                        </span>
                    </td>
                    <td class="p-3">
                        <span class="text-sm text-gray-700">${row.className}</span>
                    </td>
                    <td class="p-3 text-right">
                        <span class="text-lg font-bold text-green-600">$${row.total.toFixed(2)}</span>
                    </td>
                    <td class="p-3 text-center">
                        <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ${row.events}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-semibold view-payout-details-btn" 
                                data-driver-id="${row.driver.id}">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
            
            payoutsList.innerHTML = html;
        }

        function renderRaceResults(classId, eventData) {
            const container = document.getElementById('raceResultsContainer');
            container.innerHTML = '';
            if (!classId) {
                container.innerHTML = '<p class="text-gray-500 text-center">Select a class to see the full race report.</p>';
                return;
            }
            
            const data = eventData || state;
            const classStatus = (eventData ? eventData.completedRegistrations : state.completedRegistrations).find(c => c.id === classId) || {};
            const pointsOption = classStatus.pointsOption || 'normal';
            let pointMultiplier = 1;
            if (pointsOption === 'double') pointMultiplier = 2;
            else if (pointsOption === 'none') pointMultiplier = 0;

            const getDriver = (id) => state.drivers.find(d => d.id === id);

            let html = '';
            
            const heatsData = data.heats[classId];
            const heatResults = data.heatResults[classId];
            if(heatsData && heatResults){
                html += '<h3 class="text-2xl font-bold mb-3">Heat Results</h3>';
                heatsData.heats.forEach((heat, index) => {
                    const results = heatResults[`heat_${index}`];
                    const isRainout = results === 'rainout';
                    html += `<div class="mb-4 bg-gray-50 p-4 rounded-lg"><h4 class="text-xl font-semibold mb-2">Heat ${index + 1} ${isRainout ? '<span class="text-red-500">(RAINOUT)</span>' : ''}</h4><div class="space-y-1">`;
                    if(Array.isArray(results)) {
                        results.forEach(r => {
                            const driver = getDriver(r.driverId);
                            const points = (state.pointSettings.heat[r.position - 1] || 0) * pointMultiplier;
                            if(driver) html += `<div class="flex justify-between items-center"><span>${r.position}. ${driver.number} - ${driver.name}</span> <span class="text-sm font-semibold text-gray-600">${points} pts</span></div>`;
                        });
                    } else if (isRainout) {
                        html += '<h6>Starting Lineup:</h6><ol class="list-decimal list-inside">';
                        heat.forEach((driverId) => {
                            const driver = getDriver(driverId);
                            if (driver) html += `<li>${driver.number} - ${driver.name}</li>`;
                        });
                        html += '</ol>';
                    }
                    html += '</div></div>';
                });
            }

            const bMainResults = data.bMainResults[classId];
            if(bMainResults && bMainResults.results) {
                const isRainout = bMainResults.results === 'rainout';
                html += `<h3 class="text-2xl font-bold mt-6 mb-3">B-Main ${isRainout ? '' : 'Results'} ${isRainout ? '<span class="text-red-500 text-sm">(RAINOUT)</span>' : ''}</h3>`;
                html += '<div class="mb-4 bg-gray-50 p-4 rounded-lg"><div class="space-y-1">';
                if(Array.isArray(bMainResults.results)) {
                    html += '<ol class="list-decimal list-inside">';
                    bMainResults.results.forEach(r => {
                        const driver = getDriver(r.driverId);
                        if(driver) html += `<li>${driver.number} - ${driver.name}</li>`;
                    });
                     html += '</ol>';
                } else if (isRainout) {
                    const bMainData = data.bMains[classId];
                    if (bMainData && bMainData.lineup) {
                        html += '<h6>Starting Lineup:</h6><ol class="list-decimal list-inside">';
                        bMainData.lineup.forEach((driverId) => {
                            const driver = getDriver(driverId);
                            if (driver) html += `<li>${driver.number} - ${driver.name}</li>`;
                        });
                        html += '</ol>';
                    }
                }
                html += '</div></div>';
            }
            
            const featureResults = data.featureResults[classId];
             if(featureResults && featureResults.results) {
                const isRainout = featureResults.results === 'rainout';
                const featurePayouts = featureResults.payouts || [];
                const hasPayouts = featurePayouts.length > 0;
                
                html += `<h3 class="text-2xl font-bold mt-6 mb-3">Feature ${isRainout ? '' : 'Results'} ${isRainout ? '<span class="text-red-500 text-sm">(RAINOUT)</span>' : ''}</h3>`;
                html += '<div class="mb-4 bg-gray-50 p-4 rounded-lg"><div class="space-y-1">';
                if(Array.isArray(featureResults.results)) {
                    featureResults.results.forEach(r => {
                        const driver = getDriver(r.driverId);
                        const points = (state.pointSettings.feature[r.position - 1] || 0) * pointMultiplier;
                        const payoutInfo = featurePayouts.find(p => p.driverId === r.driverId);
                        const payoutAmount = payoutInfo ? payoutInfo.amount : 0;
                        
                        if(driver) {
                            html += `<div class="flex justify-between items-center">
                                <span>${r.position}. ${driver.number} - ${driver.name}</span> 
                                <div class="flex gap-3">
                                    <span class="text-sm font-semibold text-gray-600">${points} pts</span>
                                    ${hasPayouts ? `<span class="text-sm font-semibold text-green-600">$${payoutAmount.toLocaleString()}</span>` : ''}
                                </div>
                            </div>`;
                        }
                    });
                } else if (isRainout) {
                    const featureData = data.features[classId];
                    if (featureData && featureData.lineup) {
                        html += '<h6>Starting Lineup:</h6><ol class="list-decimal list-inside">';
                        featureData.lineup.forEach((driverId) => {
                            const driver = getDriver(driverId);
                            if (driver) html += `<li>${driver.number} - ${driver.name}</li>`;
                        });
                        html += '</ol>';
                    }
                }
                html += '</div></div>';
            }

            container.innerHTML = html || '<p class="text-gray-500 text-center">No results found for this class on this event date.</p>';
        }

        // V4: Render Race History Modal
        function renderRaceHistory() {
            const container = document.getElementById('raceHistoryContent');
            
            if (!state.raceHistory || state.raceHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No race history yet. Finalize some races to build your history!</p>';
                return;
            }
            
            // Sort by date descending (newest first)
            const sortedHistory = [...state.raceHistory].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            let html = '';
            sortedHistory.forEach((entry, index) => {
                const hasNotes = entry.notes && entry.notes.trim().length > 0;
                const hasResults = entry.featureResults && entry.featureResults.results;
                
                html += `
                    <div class="border-2 border-gray-300 rounded-lg p-4 ${index === 0 ? 'bg-blue-50' : 'bg-white'}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">${entry.className}</h4>
                                <p class="text-sm text-gray-600">üìÖ ${entry.date}</p>
                            </div>
                            <span class="text-xs text-gray-500">Finalized: ${new Date(entry.finalizedAt).toLocaleString()}</span>
                        </div>
                        
                        ${hasNotes ? `
                            <div class="mt-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                <p class="text-sm font-semibold text-gray-700 mb-1">üìù Notes:</p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${entry.notes}</p>
                            </div>
                        ` : '<p class="text-sm text-gray-500 italic mt-2">No notes recorded for this event.</p>'}
                        
                        ${hasResults && Array.isArray(entry.featureResults.results) ? `
                            <div class="mt-3">
                                <p class="text-sm font-semibold text-gray-700 mb-1">üèÅ Top 3 Finishers:</p>
                                <ol class="text-sm list-decimal list-inside text-gray-800">
                                    ${entry.featureResults.results.slice(0, 3).map(r => {
                                        const driver = state.drivers.find(d => d.id === r.driverId);
                                        return driver ? `<li>${driver.number} - ${driver.name}</li>` : '';
                                    }).join('')}
                                </ol>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderHistoryDates(classId) {
            const dateList = document.getElementById('historyDateList');
            const resultsContainer = document.getElementById('historyResultsContainer');
            const printBtn = document.getElementById('printHistoryBtn');
            dateList.innerHTML = '';
            resultsContainer.innerHTML = '<p class="text-gray-500">Select an event date to see results.</p>';
            printBtn.classList.add('hidden');

            if (!classId) {
                dateList.innerHTML = '<p class="text-gray-500">Select a class to see past event dates.</p>';
                return;
            }

            const allData = JSON.parse(localStorage.getItem('raceManagerData') || '{}');
            const eventKeys = Object.keys(allData).filter(key => key.startsWith('event_'));
            const datesWithResults = [];

            for (const key of eventKeys) {
                const eventData = allData[key];
                if (eventData.featureResults && eventData.featureResults[classId]) {
                    datesWithResults.push(key.replace('event_', ''));
                }
            }
            
            datesWithResults.sort((a, b) => new Date(b) - new Date(a));

            if (datesWithResults.length === 0) {
                dateList.innerHTML = '<p class="text-gray-500">No historical results found for this class.</p>';
                return;
            }

            datesWithResults.forEach(dateStr => {
                const dateEl = document.createElement('div');
                dateEl.className = 'driver-item';
                dateEl.textContent = dateStr;
                dateEl.dataset.eventId = `event_${dateStr}`;
                dateEl.addEventListener('click', (e) => {
                    document.querySelectorAll('#historyDateList .driver-item').forEach(el => el.classList.remove('bg-orange-100'));
                    e.currentTarget.classList.add('bg-orange-100');
                    renderHistoryForDate(classId, e.currentTarget.dataset.eventId);
                });
                dateList.appendChild(dateEl);
            });
        }

        function renderHistoryForDate(classId, eventId) {
            const allData = JSON.parse(localStorage.getItem('raceManagerData') || '{}');
            const eventData = allData[eventId];
            const container = document.getElementById('historyResultsContainer');
            container.innerHTML = '';
            
            if (!eventData) {
                container.innerHTML = '<p class="text-gray-500">Could not load data for this date.</p>';
                return;
            }
            document.getElementById('printHistoryBtn').classList.remove('hidden');

            // V4: Show weekend notes if they exist
            if (eventData.weekendNotes && eventData.weekendNotes.trim().length > 0) {
                const notesDiv = document.createElement('div');
                notesDiv.className = 'mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded';
                notesDiv.innerHTML = `
                    <h4 class="font-bold text-gray-900 mb-2">üìù Weekend Notes</h4>
                    <p class="text-sm text-gray-800 whitespace-pre-wrap">${eventData.weekendNotes}</p>
                `;
                container.appendChild(notesDiv);
            }

            // Create a temporary div to render results into
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'tempRaceResultsContainer';
            container.appendChild(resultsDiv);

            // Temporarily swap the container ID so renderRaceResults works
            const originalContainer = document.getElementById('raceResultsContainer');
            const originalId = originalContainer.id;
            originalContainer.id = 'raceResultsContainer_temp';
            resultsDiv.id = 'raceResultsContainer';
            
            // Render the results
            renderRaceResults(classId, eventData);
            
            // Restore original IDs
            resultsDiv.id = 'tempRaceResultsContainer';
            originalContainer.id = originalId;
        }

        // Update Payout Structure Dropdown in Race Setup
        function updatePayoutStructureDropdown() {
            const setupSelect = document.getElementById('payoutStructureSelect');
            if (!setupSelect) return;
            
            // Save current selection
            const currentValue = setupSelect.value;
            
            // Clear and rebuild options
            setupSelect.innerHTML = '<option value="">No Payout</option>';
            
            if (state.payoutStructures && state.payoutStructures.length > 0) {
                state.payoutStructures.forEach(structure => {
                    const option = document.createElement('option');
                    option.value = structure.id;
                    option.textContent = structure.name;
                    setupSelect.appendChild(option);
                });
            }
            
            // Restore selection if it still exists
            if (currentValue && state.payoutStructures.find(s => s.id === currentValue)) {
                setupSelect.value = currentValue;
            }
        }

        // Render Payout Structures in Settings Tab
        function renderPayoutManagement() {
            renderDriverPayoutHistory();
            
            const list = document.getElementById('payoutStructuresList');
            if (!list) return;
            
            list.innerHTML = '';
            
            // Show empty state if no structures
            if (!state.payoutStructures || state.payoutStructures.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-500 text-lg font-semibold">No Payout Structures Yet</p>
                        <p class="text-sm text-gray-400 mt-2">Click "New Structure" above to create your first payout template</p>
                    </div>
                `;
                return;
            }
            
            // Render each payout structure as a card
            state.payoutStructures.forEach(structure => {
                const totalPurse = structure.payouts.reduce((sum, p) => sum + (p || 0), 0);
                const numPositions = structure.payouts.filter(p => p > 0).length;
                
                const card = document.createElement('div');
                card.className = 'card p-6 hover:shadow-xl transition-all duration-300 cursor-pointer border-2 border-transparent hover:border-orange-300';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-800">${structure.name}</h4>
                        <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-semibold">
                            $${totalPurse.toLocaleString()}
                        </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <div class="flex justify-between">
                            <span class="font-semibold">Pays Positions:</span>
                            <span>${numPositions}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">1st Place:</span>
                            <span class="text-orange-600 font-bold">$${structure.payouts[0] || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">2nd Place:</span>
                            <span>$${structure.payouts[1] || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">3rd Place:</span>
                            <span>$${structure.payouts[2] || 0}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-payout-btn flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition font-semibold" 
                            data-id="${structure.id}">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit
                        </button>
                        <button class="delete-payout-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition" 
                            data-id="${structure.id}">
                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            
            // Update the payout structure dropdown in Race Setup
            updatePayoutStructureDropdown();
        }
        
        function renderDriverPayoutHistory() {
            const container = document.getElementById('driverPayoutHistory');
            if (!container) return;
            
            // Get all drivers who have received payouts
            const driversWithPayouts = Object.keys(state.driverPayouts)
                .map(driverId => {
                    const driver = state.drivers.find(d => d.id === driverId);
                    if (!driver) return null;
                    return {
                        driver: driver,
                        payoutData: state.driverPayouts[driverId]
                    };
                })
                .filter(Boolean)
                .sort((a, b) => b.payoutData.yearlyTotal - a.payoutData.yearlyTotal);
            
            if (driversWithPayouts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-500 text-lg font-semibold">No Payouts Recorded Yet</p>
                        <p class="text-sm text-gray-400 mt-2">Payouts will appear here after races are finalized with a payout structure</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-100 border-b-2 border-gray-300">
                        <tr>
                            <th class="p-3 text-left font-semibold">Driver</th>
                            <th class="p-3 text-left font-semibold">Number</th>
                            <th class="p-3 text-left font-semibold">Class</th>
                            <th class="p-3 text-right font-semibold">Races</th>
                            <th class="p-3 text-right font-semibold">Year Total</th>
                            <th class="p-3 text-center font-semibold">Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            driversWithPayouts.forEach(item => {
                const className = state.classes.find(c => c.id === item.driver.classId)?.name || 'Unknown';
                const raceCount = item.payoutData.races.length;
                
                html += `
                    <tr class="border-b hover:bg-orange-50 transition">
                        <td class="p-3">${item.driver.name}</td>
                        <td class="p-3">${item.driver.number}</td>
                        <td class="p-3">${className}</td>
                        <td class="p-3 text-right">${raceCount}</td>
                        <td class="p-3 text-right font-bold text-green-600">$${item.payoutData.yearlyTotal.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            <button class="view-payout-details-btn text-orange-600 hover:text-orange-700 font-semibold text-sm" 
                                data-driver-id="${item.driver.id}">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners for detail buttons
            container.querySelectorAll('.view-payout-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const driverId = e.target.dataset.driverId;
                    showPayoutDetails(driverId);
                });
            });
        }
        
        function showPayoutDetails(driverId) {
            const driver = state.drivers.find(d => d.id === driverId);
            const payoutData = state.driverPayouts[driverId];
            
            if (!driver || !payoutData) return;
            
            let detailsHtml = `
                <div class="space-y-2">
                    <h4 class="font-bold text-lg mb-3">${driver.name} (#${driver.number}) - Payout History</h4>
                    <div class="max-h-96 overflow-y-auto space-y-2">
            `;
            
            payoutData.races.forEach(race => {
                detailsHtml += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-semibold">${race.date}</div>
                            <div class="text-sm text-gray-600">${race.className} - Position: ${race.position}</div>
                        </div>
                        <div class="text-green-600 font-bold">$${race.amount.toLocaleString()}</div>
                    </div>
                `;
            });
            
            detailsHtml += `
                    </div>
                    <div class="mt-4 pt-4 border-t-2 flex justify-between items-center">
                        <span class="font-bold text-lg">Total:</span>
                        <span class="font-bold text-xl text-green-600">$${payoutData.yearlyTotal.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            showInfoModal(`Payout Details`, detailsHtml);
        }

        // --- LINEUP EDITOR FUNCTIONS ---
        
        function openLineupEditor(raceType, classId, heatIndex = null) {
            // Set hidden values
            document.getElementById('lineupEditorType').value = raceType;
            document.getElementById('lineupEditorClassId').value = classId;
            document.getElementById('lineupEditorHeatIndex').value = heatIndex || '';
            
            // Set title
            let title = 'Edit Lineup';
            if (raceType === 'heat') {
                title = `Edit Heat ${parseInt(heatIndex) + 1} Lineup`;
            } else if (raceType === 'bMain') {
                title = 'Edit B-Main Lineup';
            } else if (raceType === 'feature') {
                title = 'Edit Feature Lineup';
            }
            document.getElementById('lineupEditorTitle').textContent = title;
            
            // Get current lineup
            let currentLineup = [];
            if (raceType === 'heat') {
                const heatsData = state.heats[classId];
                if (heatsData && heatsData.heats && heatsData.heats[heatIndex]) {
                    currentLineup = heatsData.heats[heatIndex];
                }
            } else if (raceType === 'bMain') {
                currentLineup = state.bMains[classId]?.lineup || [];
            } else if (raceType === 'feature') {
                currentLineup = state.features[classId]?.lineup || [];
            }
            
            // CRITICAL: Deduplicate lineup before rendering
            currentLineup = deduplicateLineup(currentLineup);
            
            // Render current lineup
            renderCurrentLineup(currentLineup, classId);
            
            // Populate available drivers dropdown
            populateAvailableDrivers(classId, currentLineup);
            
            // FIX: Clone the add button to remove ALL previous event listeners
            const oldAddBtn = document.getElementById('addDriverToLineupBtn');
            const newAddBtn = oldAddBtn.cloneNode(true);
            oldAddBtn.parentNode.replaceChild(newAddBtn, oldAddBtn);
            
            // Attach fresh click handler directly to the new button
            newAddBtn.onclick = function() {
                const select = document.getElementById('addDriverSelect');
                const driverId = select.value;
                
                if (!driverId) {
                    showInfoModal('Error', 'Please select a driver to add');
                    return;
                }
                
                const driver = state.drivers.find(d => d.id === driverId);
                if (!driver) {
                    showInfoModal('Error', 'Driver not found');
                    return;
                }
                
                const lineupContainer = document.getElementById('currentLineupList');
                
                // Check if driver already in lineup
                const existingCard = lineupContainer.querySelector(`[data-driver-id="${driverId}"]`);
                if (existingCard) {
                    showInfoModal('Error', 'Driver is already in the lineup');
                    return;
                }
                
                const allCards = lineupContainer.querySelectorAll('[data-driver-id]');
                const newPosition = allCards.length + 1;
                
                // Create new driver card
                const driverCard = document.createElement('div');
                driverCard.className = 'flex items-center justify-between bg-white p-3 rounded-lg border-2 border-gray-200';
                driverCard.dataset.driverId = driverId;
                driverCard.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="font-bold text-lg text-orange-600 w-12 text-center">${newPosition}</div>
                        <div class="flex items-center gap-2">
                            <input type="number" value="${newPosition}" min="1" max="${newPosition}" 
                                class="position-input w-16 p-1 border-2 border-gray-300 rounded text-center font-semibold">
                        </div>
                        <div>
                            <div class="font-semibold">${driver.name}</div>
                            <div class="text-sm text-gray-600">#${driver.number}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="move-up-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">&uarr;</button>
                        <button type="button" class="move-down-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm" disabled style="opacity:0.5">&darr;</button>
                        <button type="button" class="remove-driver-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Remove</button>
                    </div>
                `;
                
                lineupContainer.appendChild(driverCard);
                updateLineupPositions();
                
                // Remove driver from dropdown
                const option = select.querySelector(`option[value="${driverId}"]`);
                if (option) option.remove();
                select.value = '';
            };
            
            // Show modal
            showModal('lineupEditorModal');
            
            // CRITICAL: Ensure all positions are correctly set after modal opens
            setTimeout(() => updateLineupPositions(), 0);
        }
        
        // Global helper function for updating positions in lineup editor
        function updateLineupPositions() {
            const lineupContainer = document.getElementById('currentLineupList');
            if (!lineupContainer) return;
            
            const cards = lineupContainer.querySelectorAll('[data-driver-id]');
            console.log(`Updating ${cards.length} driver positions`);
            
            cards.forEach((card, index) => {
                // Update position display (orange number on left)
                const posDisplay = card.querySelector('.text-orange-600');
                if (posDisplay) {
                    posDisplay.textContent = index + 1;
                } else {
                    console.warn(`No position display found for card ${index}`);
                }
                
                // Update position input
                const posInput = card.querySelector('.position-input');
                if (posInput) {
                    posInput.value = index + 1;
                    posInput.max = cards.length;
                } else {
                    console.warn(`No position input found for card ${index}`);
                }
                
                // Update move up button
                const moveUpBtn = card.querySelector('.move-up-btn');
                if (moveUpBtn) {
                    moveUpBtn.disabled = index === 0;
                    moveUpBtn.style.opacity = index === 0 ? '0.5' : '1';
                }
                
                // Update move down button
                const moveDownBtn = card.querySelector('.move-down-btn');
                if (moveDownBtn) {
                    moveDownBtn.disabled = index === cards.length - 1;
                    moveDownBtn.style.opacity = index === cards.length - 1 ? '0.5' : '1';
                }
            });
        }
        
        function renderCurrentLineup(lineup, classId) {
            const container = document.getElementById('currentLineupList');
            container.innerHTML = '';
            
            if (lineup.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No drivers in lineup</p>';
                return;
            }
            
            // CRITICAL FIX: Remove duplicates from lineup array before rendering
            const uniqueLineup = [];
            const seenDrivers = new Set();
            
            lineup.forEach(driverId => {
                if (!seenDrivers.has(driverId)) {
                    uniqueLineup.push(driverId);
                    seenDrivers.add(driverId);
                }
            });
            
            uniqueLineup.forEach((driverId, index) => {
                const driver = state.drivers.find(d => d.id === driverId);
                if (!driver) return;
                
                const driverCard = document.createElement('div');
                driverCard.className = 'flex items-center justify-between bg-white p-3 rounded-lg border-2 border-gray-200';
                driverCard.dataset.driverId = driverId;
                driverCard.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="font-bold text-lg text-orange-600 w-12 text-center">${index + 1}</div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">Position:</label>
                            <input type="number" value="${index + 1}" min="1" max="${uniqueLineup.length}" 
                                class="position-input w-20 p-2 border-2 border-gray-300 rounded text-center font-semibold">
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-lg">${driver.name}</div>
                            <div class="text-sm text-gray-600">#${driver.number}</div>
                        </div>
                    </div>
                `;
                container.appendChild(driverCard);
            });
            
            // CRITICAL: Update all positions after rendering to ensure consistency
            setTimeout(() => updateLineupPositions(), 0);
        }
        
        function populateAvailableDrivers(classId, currentLineup) {
            const select = document.getElementById('addDriverSelect');
            select.innerHTML = '<option value="">Select a driver...</option>';
            
            // Get ALL drivers in this class (not just registered ones)
            const allDriversInClass = state.drivers.filter(d => d.classId === classId);
            
            // Filter out drivers already in lineup
            const availableDrivers = allDriversInClass.filter(d => !currentLineup.includes(d.id));
            
            // Sort by driver number for easier selection
            availableDrivers.sort((a, b) => {
                const numA = parseInt(a.number) || 0;
                const numB = parseInt(b.number) || 0;
                return numA - numB;
            });
            
            availableDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = `${driver.name} - #${driver.number}`;
                select.appendChild(option);
            });
        }
        
        function saveLineupEdits() {
            const raceType = document.getElementById('lineupEditorType').value;
            const classId = document.getElementById('lineupEditorClassId').value;
            const heatIndex = document.getElementById('lineupEditorHeatIndex').value;
            
            // Get current lineup from UI
            const lineupContainer = document.getElementById('currentLineupList');
            const driverCards = lineupContainer.querySelectorAll('[data-driver-id]');
            let newLineup = Array.from(driverCards).map(card => card.dataset.driverId);
            
            // CRITICAL FIX: Remove duplicates before saving
            const uniqueLineup = [];
            const seenDrivers = new Set();
            newLineup.forEach(driverId => {
                if (!seenDrivers.has(driverId)) {
                    uniqueLineup.push(driverId);
                    seenDrivers.add(driverId);
                }
            });
            newLineup = uniqueLineup;
            
            // Save to appropriate state location
            if (raceType === 'heat' && heatIndex !== '') {
                if (!state.heats[classId]) state.heats[classId] = { heats: [] };
                if (!state.heats[classId].heats) state.heats[classId].heats = [];
                state.heats[classId].heats[parseInt(heatIndex)] = newLineup;
            } else if (raceType === 'bMain') {
                if (!state.bMains[classId]) state.bMains[classId] = { lineup: [] };
                state.bMains[classId].lineup = newLineup;
            } else if (raceType === 'feature') {
                if (!state.features[classId]) state.features[classId] = { lineup: [] };
                state.features[classId].lineup = newLineup;
            }
            
            // Save state
            saveState();
            
            // Re-render appropriate section
            if (raceType === 'heat') {
                renderHeatRaces(classId);
            } else if (raceType === 'bMain') {
                renderBMain(classId);
            } else if (raceType === 'feature') {
                renderFeature(classId);
            }
            
            // Close modal
            hideModal('lineupEditorModal');
            
            showInfoModal('Success', 'Lineup updated successfully!');
        }


        // --- CRUD Functions ---

        function createClass(className) {
            if (!className.trim()) return;
            const newClass = { id: generateUniqueId(), name: className.trim() };
            state.classes.push(newClass);
            saveState();
            renderClasses();
        }
        
        function setupDriverModal() {
            const addDriverBtn = document.getElementById('addDriverBtn');
            const cancelBtn = document.getElementById('driverModalCancelBtn');
            const driverForm = document.getElementById('driverForm');
            
            addDriverBtn.addEventListener('click', () => {
                driverForm.reset();
                document.getElementById('driverId').value = '';
                document.getElementById('driverModalTitle').textContent = 'Add New Driver';
                showModal('driverModal');
            });
            
            cancelBtn.addEventListener('click', () => hideModal('driverModal'));
            
            driverForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const driverId = document.getElementById('driverId').value;
                const driverNumber = document.getElementById('driverNumber').value.trim();
                const driverClassId = document.getElementById('driverClass').value;
                
                // V3: Validate unique car number within class
                const existingDriver = state.drivers.find(d => 
                    d.number === driverNumber && 
                    d.classId === driverClassId && 
                    d.id !== driverId
                );
                
                if (existingDriver) {
                    showInfoModal("Duplicate Number", `Car number "${driverNumber}" is already used by ${existingDriver.name} in this class. Please choose a different number.`);
                    return;
                }
                
                const driverData = {
                    name: document.getElementById('driverName').value.trim(),
                    nickname: document.getElementById('driverNickname').value.trim(), // V3: New field
                    number: driverNumber,
                    license: document.getElementById('driverLicense').value.trim(),
                    phone: document.getElementById('driverPhone').value.trim(),
                    address: document.getElementById('driverAddress').value.trim(), // V3: New field
                    city: document.getElementById('driverCity').value.trim(), // V3: New field
                    state: document.getElementById('driverState').value.trim().toUpperCase(), // V3: New field
                    classId: driverClassId,
                    sponsors: document.getElementById('driverSponsors').value.trim(), // V4: New field
                    funFacts: document.getElementById('driverFunFacts').value.trim(), // V4: New field
                };
                
                if (driverId) {
                    const index = state.drivers.findIndex(d => d.id === driverId);
                    if (index > -1) state.drivers[index] = { ...state.drivers[index], ...driverData };
                } else {
                    driverData.id = generateUniqueId();
                    state.drivers.push(driverData);
                    
                    // V3: Initialize statistics tracking for new driver
                    if (!state.seasonPoints[driverData.id]) {
                        state.seasonPoints[driverData.id] = {
                            points: 0,
                            heatWins: 0,
                            featureWins: 0
                        };
                    }
                }
                saveState();
                renderDrivers();
                hideModal('driverModal');
            });
        }
        
        // --- Registration Logic ---
        function registerDriver(event) {
            const { driverId, classId } = event.currentTarget.dataset;
            if (!state.registrations[classId]) state.registrations[classId] = { driverIds: [] };
            state.registrations[classId].driverIds.push(driverId);
            saveState();
            renderRegistrationForClass(classId);
        }

        function unregisterDriver(event) {
            const { driverId, classId } = event.currentTarget.dataset;
            if (state.registrations[classId]) {
                state.registrations[classId].driverIds = state.registrations[classId].driverIds.filter(id => id !== driverId);
                saveState();
                renderRegistrationForClass(classId);
            }
        }

        function completeRegistration() {
            const classSelect = document.getElementById('registrationClassSelect');
            const selectedClassId = classSelect.value;
            if (!selectedClassId) {
                showInfoModal("Error", "Please select a class first.");
                return;
            }

            const selectedClass = state.classes.find(c => c.id === selectedClassId);
            const registeredDriverIds = state.registrations[selectedClassId]?.driverIds || [];

            if (registeredDriverIds.length === 0) {
                showInfoModal("Error", "Cannot complete registration with zero drivers.");
                return;
            }

            const statusData = { id: selectedClassId, registrationCompleted: true, registeredDrivers: registeredDriverIds, className: selectedClass.name };
            const existingIndex = state.completedRegistrations.findIndex(cr => cr.id === selectedClassId);
            if (existingIndex > -1) state.completedRegistrations[existingIndex] = statusData;
            else state.completedRegistrations.push(statusData);

            saveState();
            renderAll();
            renderRegistrationForClass(selectedClassId);
            showInfoModal("Success!", `${selectedClass.name} registration is complete!`);
        }
        
        // --- Race Setup Logic ---
        function randomPillDraw() {
            const lineupRows = document.querySelectorAll('#lineupSetupList tr');
            if (lineupRows.length === 0) {
                showInfoModal("No Drivers", "No drivers to draw for.");
                return;
            }
            const numbers = Array.from({ length: 250 }, (_, i) => i + 1);
            for (let i = numbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
            }
            lineupRows.forEach((row, index) => {
                const input = row.querySelector('input');
                if (input) input.value = numbers[index];
            });
        }
        
        function generateLineups() {
            const selectedClassId = document.getElementById('raceSetupClassSelect').value;
            if (!selectedClassId) {
                showInfoModal("Error", "Please select a class first.");
                return;
            }

            const skipHeats = document.getElementById('skipHeatsCheckbox').checked;

            const generate = () => {
                const lineupRows = document.querySelectorAll('#lineupSetupList tr');
                const driversWithPills = [];
                for (const row of lineupRows) {
                    const driverId = row.dataset.driverId;
                    const pillInput = row.querySelector('input');
                    const pillValue = pillInput.value.trim();

                    if (!pillValue || isNaN(parseFloat(pillValue))) {
                        showInfoModal("Input Error", `Please enter a valid pill number or time for all drivers. Error on driver: ${row.cells[0].textContent}`);
                        return;
                    }
                    driversWithPills.push({ id: driverId, pill: parseFloat(pillValue) });
                }
                if (driversWithPills.length === 0) {
                    showInfoModal("Error", "No drivers to generate lineups for.");
                    return;
                }

                driversWithPills.sort((a, b) => a.pill - b.pill);

                if (skipHeats) {
                    // --- Logic for skipping heats ---
                    const featureLineup = driversWithPills.map(d => d.id);
                    state.features[selectedClassId] = { lineup: featureLineup, invert: '0' };
                    
                    const regIndex = state.completedRegistrations.findIndex(cr => cr.id === selectedClassId);
                    if (regIndex > -1) {
                         const raceSettings = {
                            bMainEnabled: false,
                            featureStartCount: 0,
                            heatTransferCount: 0,
                            pointsOption: document.querySelector('input[name="pointsOption"]:checked').value,
                            payoutStructure: document.getElementById('payoutStructureSelect').value,
                        };
                        state.completedRegistrations[regIndex] = { ...state.completedRegistrations[regIndex], heatsGenerated: true, ...raceSettings, skippedHeats: true };
                    }
                    
                    // V3: Award show-up points if enabled
                    const showUpPointsEnabled = document.getElementById('showUpPointsCheckbox').checked;
                    if (showUpPointsEnabled && state.pointSettings.showUpPoints > 0) {
                        // V4: Check if show-up points already awarded for this class
                        const regStatus = state.completedRegistrations[regIndex];
                        if (!regStatus.showUpPointsAwarded) {
                            driversWithPills.forEach(driver => {
                                if (!state.seasonPoints[driver.id]) {
                                    state.seasonPoints[driver.id] = { points: 0, heatWins: 0, featureWins: 0 };
                                }
                                state.seasonPoints[driver.id].points += state.pointSettings.showUpPoints;
                            });
                            // V4: Mark that show-up points have been awarded
                            state.completedRegistrations[regIndex].showUpPointsAwarded = true;
                        }
                    }
                    
                    saveState();
                    renderAll();
                    document.getElementById('raceSetupClassSelect').dispatchEvent(new Event('change'));
                    
                    // Auto-select this class in the Feature dropdown
                    document.getElementById('featureClassSelect').value = selectedClassId;
                    
                    showInfoModal("Success!", `Feature lineup has been generated! Please proceed to the Feature tab.`);

                } else {
                    // --- Existing logic for generating heats ---
                    const numberOfHeats = parseInt(document.getElementById('manualHeatCount').value) || 0;
                    if (numberOfHeats <= 0) {
                        showInfoModal("Input Error", "Please enter a valid number of heat races (1 or more).");
                        return;
                    }

                    if (driversWithPills.length < numberOfHeats) {
                        showInfoModal("Input Error", "Cannot have more heat races than drivers.");
                        return;
                    }

                    const heats = Array.from({ length: numberOfHeats }, () => []);
                    driversWithPills.forEach((driver, index) => heats[index % numberOfHeats].push(driver.id));
                    
                    state.heats[selectedClassId] = { heats: heats };
                    const regIndex = state.completedRegistrations.findIndex(cr => cr.id === selectedClassId);
                    if (regIndex > -1) {
                        const raceSettings = {
                            bMainEnabled: document.getElementById('enableBMain').checked,
                            featureStartCount: parseInt(document.getElementById('featureStartCount').value) || 0,
                            heatTransferCount: parseInt(document.getElementById('heatTransferCount').value) || 0,
                            pointsOption: document.querySelector('input[name="pointsOption"]:checked').value,
                            payoutStructure: document.getElementById('payoutStructureSelect').value,
                        };
                        state.completedRegistrations[regIndex] = { ...state.completedRegistrations[regIndex], heatsGenerated: true, ...raceSettings, skippedHeats: false };
                    }
                    
                    // V3: Award show-up points if enabled
                    const showUpPointsEnabled = document.getElementById('showUpPointsCheckbox').checked;
                    if (showUpPointsEnabled && state.pointSettings.showUpPoints > 0) {
                        // V4: Check if show-up points already awarded for this class
                        const regStatus = state.completedRegistrations[regIndex];
                        if (!regStatus.showUpPointsAwarded) {
                            driversWithPills.forEach(driver => {
                                if (!state.seasonPoints[driver.id]) {
                                    state.seasonPoints[driver.id] = { points: 0, heatWins: 0, featureWins: 0 };
                                }
                                state.seasonPoints[driver.id].points += state.pointSettings.showUpPoints;
                            });
                            // V4: Mark that show-up points have been awarded
                            state.completedRegistrations[regIndex].showUpPointsAwarded = true;
                        }
                    }
                    
                    saveState();
                    renderAll();
                    document.getElementById('raceSetupClassSelect').dispatchEvent(new Event('change'));
                    
                    // Auto-select this class in the Heat Races dropdown
                    document.getElementById('heatRacesClassSelect').value = selectedClassId;
                    
                    showInfoModal("Success!", `Heat Races have been generated! Please proceed to the Heat Races tab.`);
                }
            };

            const confirmationMessage = skipHeats ? "Generate Feature Lineup?" : "Generate Heats?";
            showConfirmationModal(confirmationMessage, "Are you sure? Lineups cannot be changed after this point.", generate);
        }
        
        // --- Heat Race Logic ---
        function saveHeatResults(event) {
            const heatIndex = event.target.dataset.heatIndex;
            const classId = event.target.dataset.classId || document.getElementById('heatRacesClassSelect').value;
            if (!classId) return;
            
            // V3: Get results from new entry system
            const heat = state.heats[classId].heats[heatIndex];
            const driversInHeat = heat.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
            
            const resultData = getV3Results(`heat-${classId}-${heatIndex}`, driversInHeat);
            
            if (!resultData.valid) {
                showInfoModal('Error', resultData.error);
                return;
            }
            
            // V4: Wins are now ONLY counted during finalization, not when saving individual results
            // This prevents double-counting
            
            if (!state.heatResults[classId]) state.heatResults[classId] = {};
            state.heatResults[classId][`heat_${heatIndex}`] = resultData.results;
            saveState();
            renderHeatRaces(classId);
            renderHeatRacesClasses();
        }
        
        function finalizeHeatResultsAndSetNextLineup() {
            const classId = document.getElementById('heatRacesClassSelect').value;
            if (!classId) return;
            const classStatus = state.completedRegistrations.find(c => c.id === classId);
            const heatResults = state.heatResults[classId];
            if (!classStatus || !heatResults) {
                showInfoModal("Error", "Missing data to finalize heats.");
                return;
            }

            // Filter out rainouts before processing
            const validHeatResults = Object.entries(heatResults)
                .filter(([key, res]) => res !== 'rainout')
                .flatMap(([key, res]) => res.map(r => ({...r, heatIndex: parseInt(key.split('_')[1]) })));
            
            if (validHeatResults.length === 0) {
                const regIndex = state.completedRegistrations.findIndex(cr => cr.id === classId);
                if (regIndex > -1) {
                    state.completedRegistrations[regIndex].raceCompleted = true;
                }
                saveState();
                renderHeatRaces(classId); // Re-render to hide finalize button
                showInfoModal("Races Concluded", "All heats were rained out. This class is now marked as complete for the evening.");
                return; 
            }

            // Separate regular finishers from DNS/DQ
            const regularFinishers = validHeatResults.filter(r => typeof r.position === 'number');
            const dnsDrivers = validHeatResults.filter(r => r.position === 'DNS').map(r => r.driverId);
            const dqDrivers = validHeatResults.filter(r => r.position === 'DQ').map(r => r.driverId);

            if (classStatus.bMainEnabled && classStatus.heatTransferCount > 0) {
                const featureTransfers = regularFinishers.filter(r => r.position <= classStatus.heatTransferCount).sort((a, b) => a.position - b.position || a.heatIndex - b.heatIndex);
                const bMainContenders = regularFinishers.filter(r => r.position > classStatus.heatTransferCount).sort((a, b) => a.position - b.position || a.heatIndex - b.heatIndex);
                
                // DNS/DQ go to back of B-Main
                const bMainLineup = [...bMainContenders.map(d => d.driverId), ...dnsDrivers, ...dqDrivers];
                if (bMainLineup.length > 0) state.bMains[classId] = { lineup: bMainLineup };
                
                state.features[classId] = { lineup: featureTransfers.map(d => d.driverId), fromHeats: true, invert: '0' };
                
                // Auto-select this class in B-Main dropdown
                document.getElementById('bMainClassSelect').value = classId;
                
                showInfoModal("Success!", "B-Main and initial Feature lineup have been set! DNS/DQ drivers placed at back of B-Main.");
            } else {
                regularFinishers.sort((a, b) => a.position - b.position || a.heatIndex - b.heatIndex);
                // DNS/DQ go to back of Feature
                const featureLineup = [...regularFinishers.map(d => d.driverId), ...dnsDrivers, ...dqDrivers];
                state.features[classId] = { lineup: featureLineup, invert: '0' };
                
                // Auto-select this class in Feature dropdown
                document.getElementById('featureClassSelect').value = classId;
                
                showInfoModal("Success!", "Feature lineup has been set! DNS/DQ drivers placed at back.");
            }
            saveState();
            renderNextRaceClasses('bMain');
            renderNextRaceClasses('feature');
        }
        
        // --- B-Main Logic ---
        function saveBMainResults(event) {
            const classId = event.target.dataset.classId || document.getElementById('bMainClassSelect').value;
            if (!classId) return;
            
            // V3: Get results from new entry system
            const raceData = state.bMains[classId];
            const driversInBMain = raceData.lineup.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
            
            const resultData = getV3Results(`bmain-${classId}`, driversInBMain);
            
            if (!resultData.valid) {
                showInfoModal('Error', resultData.error);
                return;
            }
            
            state.bMainResults[classId] = { results: resultData.results };
            saveState();
            renderBMain(classId);
            renderNextRaceClasses('bMain');
        }

        function finalizeBMain() {
             const classId = document.getElementById('bMainClassSelect').value;
             if (!classId) return;
            const classStatus = state.completedRegistrations.find(c => c.id === classId);
            const bMainResults = state.bMainResults[classId]?.results;
            const featureData = state.features[classId];
            if(!classStatus || !bMainResults || !featureData) {
                showInfoModal("Error", "Missing data to finalize B-Main.");
                return;
            }
            
            // Separate regular finishers from DNS/DQ
            const regularFinishers = bMainResults.filter(r => typeof r.position === 'number');
            const dnsDrivers = bMainResults.filter(r => r.position === 'DNS').map(r => r.driverId);
            const dqDrivers = bMainResults.filter(r => r.position === 'DQ').map(r => r.driverId);
            
            // Transfer top finishers to Feature, DNS/DQ go to back
            const transferCount = Math.max(0, (classStatus.featureStartCount || 0) - featureData.lineup.length);
            const bMainTransfers = regularFinishers.slice(0, transferCount).map(r => r.driverId);
            const combinedLineup = [...featureData.lineup, ...bMainTransfers, ...dnsDrivers, ...dqDrivers];
            
            // SAFETY: Deduplicate in case of any accidental duplicates
            state.features[classId].lineup = deduplicateLineup(combinedLineup);
            if (!state.features[classId].invert) state.features[classId].invert = '0';
            saveState();
            renderNextRaceClasses('feature');
            
            // Auto-select this class in Feature dropdown
            document.getElementById('featureClassSelect').value = classId;
            
            showInfoModal("Success!", "Final Feature lineup has been set! DNS/DQ drivers placed at back.");
        }

        // --- Feature Logic ---
         function saveFeatureResults(event) {
            const classId = event.target.dataset.classId || document.getElementById('featureClassSelect').value;
            if (!classId) return;
            
            // V3: Get results from new entry system
            const raceData = state.features[classId];
            const displayLineup = [...raceData.lineup];
            const driversInLineup = displayLineup.map(driverId => state.drivers.find(d => d.id === driverId)).filter(d => d);
            
            const resultData = getV3Results(`feature-${classId}`, driversInLineup);
            
            if (!resultData.valid) {
                showInfoModal('Error', resultData.error);
                return;
            }
            
            // V4: Wins are now ONLY counted during finalization, not when saving individual results
            // This prevents double-counting
            
            state.featureResults[classId] = { results: resultData.results };
            saveState();
            renderFeature(classId);
            renderNextRaceClasses('feature');
        }
        
        // --- Points & Finalize Logic ---
        function savePointSettings() {
            state.pointSettings.heat = Array.from(document.querySelectorAll('#heatPointsContainer input')).map(input => parseInt(input.value) || 0);
            state.pointSettings.feature = Array.from(document.querySelectorAll('#featurePointsContainer input')).map(input => parseInt(input.value) || 0);
            state.pointSettings.showUpPoints = parseInt(document.getElementById('showUpPoints').value) || 0; // V3: Save show-up points
            saveState();
            showInfoModal("Success", "Point settings saved successfully!");
        }

        function finalizeFeatureAndAwardPoints() {
            const classId = document.getElementById('featureClassSelect').value;
            if(!classId) return;
            const classStatus = state.completedRegistrations.find(c => c.id === classId);
            
            // V4: Enhanced duplicate prevention - check multiple flags
            if(classStatus && classStatus.raceCompleted) {
                showInfoModal("Already Completed", "Points have already been awarded for this race.");
                return;
            }
            
            const eventDate = document.getElementById('eventDate').value;
            if (!eventDate) {
                showInfoModal("Error", "Please select an event date.");
                return;
            }
            
            const heatResults = state.heatResults[classId] || {};
            const featureResults = state.featureResults[classId]?.results;
            if(!classStatus || !featureResults || (featureResults !== 'rainout' && !Array.isArray(featureResults))) {
                showInfoModal("Error", "Feature results must be saved before finalizing.");
                return;
            }
            const pointsOption = classStatus.pointsOption || 'normal';
            let pointMultiplier = (pointsOption === 'double') ? 2 : (pointsOption === 'none') ? 0 : 1;
            const allHeatResultsFlat = Object.values(heatResults).flat();
            
            // CALCULATE PAYOUTS
            const payoutStructureId = classStatus.payoutStructure;
            const payoutStructure = payoutStructureId ? state.payoutStructures.find(s => s.id === payoutStructureId) : null;
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            
            // Initialize feature results payout array if using payouts
            if (payoutStructure && Array.isArray(featureResults)) {
                if (!state.featureResults[classId].payouts) {
                    state.featureResults[classId].payouts = [];
                }
            }
            
            // V4: Track this event's contribution to stats
            const eventKey = `${eventDate}_${classId}`;
            
            for(const driverId of classStatus.registeredDrivers) {
                if (!state.seasonPoints[driverId]) {
                    state.seasonPoints[driverId] = { 
                        points: 0, 
                        starts: 0, 
                        featureWins: 0, 
                        heatWins: 0, 
                        top5s: 0, 
                        top10s: 0, 
                        classId: classId,
                        awardedEvents: [] // V4: Track which events have awarded points
                    };
                }
                
                // V4: Skip if this event already awarded points to this driver
                if (!state.seasonPoints[driverId].awardedEvents) {
                    state.seasonPoints[driverId].awardedEvents = [];
                }
                if (state.seasonPoints[driverId].awardedEvents.includes(eventKey)) {
                    console.warn(`Points already awarded for driver ${driverId} at event ${eventKey}`);
                    continue; // Skip this driver, already processed
                }
                
                let totalPoints = 0, heatWins = 0, featureWins = 0, top5s = 0, top10s = 0;
                
                if (!classStatus.skippedHeats) {
                    const heatResult = allHeatResultsFlat.find(r => r.driverId === driverId);
                    if(heatResult) {
                        totalPoints += (state.pointSettings.heat[heatResult.position - 1] || 0);
                        if(heatResult.position === 1) heatWins = 1;
                    }
                }

                if(Array.isArray(featureResults)) {
                    const featureResult = featureResults.find(r => r.driverId === driverId);
                    if(featureResult) {
                         totalPoints += (state.pointSettings.feature[featureResult.position - 1] || 0);
                         if(featureResult.position === 1) featureWins = 1;
                         if(featureResult.position <= 5) top5s = 1;
                         if(featureResult.position <= 10) top10s = 1;
                         
                         // CALCULATE AND SAVE PAYOUT for this driver
                         if (payoutStructure && featureResult.position <= payoutStructure.payouts.length) {
                             const payoutAmount = payoutStructure.payouts[featureResult.position - 1] || 0;
                             if (payoutAmount > 0) {
                                 // Initialize driver's payout tracking if needed
                                 if (!state.driverPayouts[driverId]) {
                                     state.driverPayouts[driverId] = { yearlyTotal: 0, races: [] };
                                 }
                                 
                                 // Add to driver's yearly total
                                 state.driverPayouts[driverId].yearlyTotal += payoutAmount;
                                 
                                 // Record this race payout
                                 state.driverPayouts[driverId].races.push({
                                     date: eventDate,
                                     className: className,
                                     position: featureResult.position,
                                     amount: payoutAmount
                                 });
                                 
                                 // Also save to the feature results for this event
                                 state.featureResults[classId].payouts.push({
                                     driverId: driverId,
                                     position: featureResult.position,
                                     amount: payoutAmount
                                 });
                             }
                         }
                    }
                }

                const driverStats = state.seasonPoints[driverId];
                driverStats.points += (totalPoints * pointMultiplier);
                driverStats.starts += 1;
                driverStats.featureWins += featureWins;
                driverStats.heatWins += heatWins;
                driverStats.top5s += top5s;
                driverStats.top10s += top10s;
                
                // V4: Mark this event as processed for this driver
                driverStats.awardedEvents.push(eventKey);
            }
            const regIndex = state.completedRegistrations.findIndex(cr => cr.id === classId);
            if(regIndex > -1) state.completedRegistrations[regIndex].raceCompleted = true;
            
            // V4: Save this race to history with notes
            if (!state.raceHistory) state.raceHistory = [];
            state.raceHistory.push({
                date: eventDate,
                classId: classId,
                className: className,
                notes: state.weekendNotes || '',
                heatResults: state.heatResults[classId] || {},
                featureResults: state.featureResults[classId] || {},
                payouts: payoutStructure ? (state.featureResults[classId]?.payouts || []) : null,
                finalizedAt: new Date().toISOString()
            });
            
            saveState();
            renderAll();
            showInfoModal("Success!", `Race finalized! Points${payoutStructure ? ' and payouts' : ''} awarded!`);
            switchTab('results');
            document.getElementById('raceResultsClassSelect').value = classId;
            renderRaceResults(classId);
        }
            
        // V3: CSV Export Functions (Feature #8)
        // Generic CSV generation and download
        function downloadCSV(data, filename) {
            const csv = data.map(row => row.map(cell => {
                // Escape quotes and wrap in quotes if contains comma, newline, or quote
                const cellStr = String(cell || '');
                if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                    return '"' + cellStr.replace(/"/g, '""') + '"';
                }
                return cellStr;
            }).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Export Heat Lineups
        function exportHeatLineups() {
            const classId = document.getElementById('heatRacesClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const heats = state.heats[classId]?.heats || [];
            
            const data = [['Class', 'Heat', 'Position', 'Car Number', 'Driver Name', 'City', 'State']];
            
            heats.forEach((heat, heatIndex) => {
                heat.forEach((driverId, position) => {
                    const driver = state.drivers.find(d => d.id === driverId);
                    if (driver) {
                        data.push([
                            className,
                            `Heat ${heatIndex + 1}`,
                            position + 1,
                            driver.number,
                            driver.name,
                            driver.city || '',
                            driver.state || ''
                        ]);
                    }
                });
            });
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `heat_lineups_${className}_${eventDate}.csv`);
        }
        
        // Export Heat Results
        function exportHeatResults() {
            const classId = document.getElementById('heatRacesClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const heatResults = state.heatResults[classId] || {};
            
            const data = [['Class', 'Heat', 'Position', 'Car Number', 'Driver Name', 'City', 'State']];
            
            Object.entries(heatResults).forEach(([heatKey, results]) => {
                if (results === 'rainout') {
                    const heatNum = heatKey.replace('heat_', '');
                    data.push([className, `Heat ${parseInt(heatNum) + 1}`, 'RAINOUT', '', '', '', '']);
                } else if (Array.isArray(results)) {
                    results.forEach(result => {
                        const driver = state.drivers.find(d => d.id === result.driverId);
                        const heatNum = heatKey.replace('heat_', '');
                        if (driver) {
                            data.push([
                                className,
                                `Heat ${parseInt(heatNum) + 1}`,
                                result.position,
                                driver.number,
                                driver.name,
                                driver.city || '',
                                driver.state || ''
                            ]);
                        }
                    });
                }
            });
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `heat_results_${className}_${eventDate}.csv`);
        }
        
        // Export B-Main Lineup
        function exportBMainLineup() {
            const classId = document.getElementById('bMainClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const lineup = state.bMains[classId]?.lineup || [];
            
            const data = [['Class', 'Race', 'Position', 'Car Number', 'Driver Name', 'City', 'State']];
            
            lineup.forEach((driverId, position) => {
                const driver = state.drivers.find(d => d.id === driverId);
                if (driver) {
                    data.push([
                        className,
                        'B-Main',
                        position + 1,
                        driver.number,
                        driver.name,
                        driver.city || '',
                        driver.state || ''
                    ]);
                }
            });
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `bmain_lineup_${className}_${eventDate}.csv`);
        }
        
        // Export B-Main Results
        function exportBMainResults() {
            const classId = document.getElementById('bMainClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const results = state.bMainResults[classId]?.results;
            
            const data = [['Class', 'Race', 'Position', 'Car Number', 'Driver Name', 'City', 'State']];
            
            if (results === 'rainout') {
                data.push([className, 'B-Main', 'RAINOUT', '', '', '', '']);
            } else if (Array.isArray(results)) {
                results.forEach(result => {
                    const driver = state.drivers.find(d => d.id === result.driverId);
                    if (driver) {
                        data.push([
                            className,
                            'B-Main',
                            result.position,
                            driver.number,
                            driver.name,
                            driver.city || '',
                            driver.state || ''
                        ]);
                    }
                });
            }
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `bmain_results_${className}_${eventDate}.csv`);
        }
        
        // Export Feature Lineup
        function exportFeatureLineup() {
            const classId = document.getElementById('featureClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const lineup = state.features[classId]?.lineup || [];
            
            const data = [['Class', 'Race', 'Position', 'Car Number', 'Driver Name', 'City', 'State']];
            
            lineup.forEach((driverId, position) => {
                const driver = state.drivers.find(d => d.id === driverId);
                if (driver) {
                    data.push([
                        className,
                        'Feature',
                        position + 1,
                        driver.number,
                        driver.name,
                        driver.city || '',
                        driver.state || ''
                    ]);
                }
            });
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `feature_lineup_${className}_${eventDate}.csv`);
        }
        
        // Export Feature Results
        function exportFeatureResults() {
            const classId = document.getElementById('featureClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const results = state.featureResults[classId]?.results;
            const payouts = state.featureResults[classId]?.payouts || [];
            
            const data = [['Class', 'Race', 'Position', 'Car Number', 'Driver Name', 'City', 'State', 'Payout']];
            
            if (results === 'rainout') {
                data.push([className, 'Feature', 'RAINOUT', '', '', '', '', '']);
            } else if (Array.isArray(results)) {
                results.forEach(result => {
                    const driver = state.drivers.find(d => d.id === result.driverId);
                    const payout = payouts.find(p => p.driverId === result.driverId);
                    if (driver) {
                        data.push([
                            className,
                            'Feature',
                            result.position,
                            driver.number,
                            driver.name,
                            driver.city || '',
                            driver.state || '',
                            payout ? `$${payout.amount}` : ''
                        ]);
                    }
                });
            }
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `feature_results_${className}_${eventDate}.csv`);
        }
        
        // Export Points Standings
        function exportPointsStandings() {
            const classId = document.getElementById('pointsClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class first.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
            const drivers = state.drivers.filter(d => d.classId === classId);
            
            const data = [['Rank', 'Car Number', 'Driver Name', 'City', 'State', 'Points', 'Starts', 'Feature Wins', 'Heat Wins', 'Top 5s', 'Top 10s']];
            
            const standings = drivers.map(driver => {
                const stats = state.seasonPoints[driver.id] || {
                    points: 0,
                    starts: 0,
                    featureWins: 0,
                    heatWins: 0,
                    top5s: 0,
                    top10s: 0
                };
                return {
                    driver,
                    stats
                };
            }).sort((a, b) => b.stats.points - a.stats.points);
            
            standings.forEach((item, index) => {
                data.push([
                    index + 1,
                    item.driver.number,
                    item.driver.name,
                    item.driver.city || '',
                    item.driver.state || '',
                    item.stats.points,
                    item.stats.starts,
                    item.stats.featureWins,
                    item.stats.heatWins,
                    item.stats.top5s,
                    item.stats.top10s
                ]);
            });
            
            const eventDate = document.getElementById('eventDate').value;
            downloadCSV(data, `points_standings_${className}_${eventDate}.csv`);
        }
        
        // Export Payout Summary
        function exportPayoutSummary() {
            const data = [['Driver', 'Car Number', 'Class', 'Event Date', 'Race Type', 'Position', 'Payout']];
            
            // Collect all payout data from all events
            const allData = JSON.parse(localStorage.getItem('raceManagerData') || '{}');
            
            Object.keys(allData).forEach(key => {
                if (!key.startsWith('event_')) return;
                
                const eventDate = key.replace('event_', '');
                const eventData = allData[key];
                
                // Feature payouts
                if (eventData.featureResults) {
                    Object.entries(eventData.featureResults).forEach(([classId, results]) => {
                        const className = state.classes.find(c => c.id === classId)?.name || 'Unknown';
                        const payouts = results.payouts || [];
                        
                        payouts.forEach(payout => {
                            const driver = state.drivers.find(d => d.id === payout.driverId);
                            if (driver) {
                                data.push([
                                    driver.name,
                                    driver.number,
                                    className,
                                    eventDate,
                                    'Feature',
                                    payout.position,
                                    `$${payout.amount}`
                                ]);
                            }
                        });
                    });
                }
            });
            
            const today = new Date().toISOString().split('T')[0];
            downloadCSV(data, `payout_summary_${today}.csv`);
        }

        function finalizeRaceWeekend() {
            if (state.completedRegistrations.length === 0) {
                showInfoModal("Nothing to Finalize", "No classes have been run for this event.");
                return;
            }
            const incompleteClasses = state.completedRegistrations.filter(c => !c.raceCompleted);
            if (incompleteClasses.length > 0) {
                showInfoModal("Cannot Finalize", `The following classes are not complete: ${incompleteClasses.map(c => c.className).join(', ')}. Please finalize all races.`);
                return;
            }
            showConfirmationModal("Finalize Race Weekend?", "This will advance to the next day for a new race event. The current event will be saved to history.",
                () => {
                    const currentDate = new Date(document.getElementById('eventDate').value + 'T00:00:00');
                    currentDate.setDate(currentDate.getDate() + 1);
                    const nextDate = currentDate.toISOString().split('T')[0];
                    localStorage.setItem('raceManagerEventDate', nextDate);
                    showInfoModal("Success!", `Race weekend finalized! Advancing to ${nextDate}.`);
                    setTimeout(() => window.location.reload(), 1500); 
                }
            );
        }

        function finalizeSeason() {
            _passwordProtectedAction = () => {
                showConfirmationModal("Finalize ENTIRE Season?", "This will delete <strong>ALL application data</strong>. Are you sure?", () => {
                    localStorage.removeItem('raceManagerData');
                    showInfoModal('Season Finalized!', 'All application data has been reset.');
                    setTimeout(() => window.location.reload(), 1500);
                });
            };
            document.getElementById('passwordModalTitle').textContent = 'Administrator Password Required';
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            showModal('passwordModal');
        }

        // --- Print ---
        function printLineups(containerId, title, className) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            // V3: Enhanced print styles with larger fonts and city/state
            printWindow.document.write(`<style>
                body{font-family:sans-serif; margin: 20px;} 
                h1,h2,h3{text-align:center;} 
                .race-container{page-break-inside: avoid; border:1px solid #ccc; padding:10px; margin-bottom: 20px;} 
                table{width:100%; border-collapse:collapse; margin-top: 10px;} 
                td,th{border:1px solid #ddd; padding:12px; text-align:left;} 
                th{background-color:#f2f2f2; font-weight: bold;} 
                .pos-col{width: 60px; text-align: center; font-weight: bold; font-size: 1.5em;}
                .driver-number{font-size: 2em; font-weight: 800; color: #f97316; display: inline-block; margin-right: 10px;}
                .driver-name{font-size: 1.5em; font-weight: 600; color: #1f2937; display: block; margin-bottom: 4px;}
                .driver-location{font-size: 0.9em; color: #6b7280; display: block;}
            </style>`);
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>${title} - ${document.getElementById('eventDate').value}</h1>`);
            printWindow.document.write(`<h2>${className}</h2>`);
            
            const raceContainers = container.querySelectorAll('.bg-gray-50');
            raceContainers.forEach(raceDiv => {
                const raceTitleEl = raceDiv.querySelector('h3') || raceDiv.querySelector('h4');
                if (!raceTitleEl) return;
                const raceTitle = raceTitleEl.textContent;
                
                // V3: Extract driver data including city/state
                const driverElements = raceDiv.querySelectorAll('[data-driver-id]');
                const drivers = Array.from(driverElements).map(el => {
                    const driverId = el.dataset.driverId;
                    const driver = state.drivers.find(d => d.id === driverId);
                    if (!driver) return null;
                    
                    // Format: "#68 John Doe<br>Akron, OH"
                    const cityState = (driver.city && driver.state) ? `${driver.city}, ${driver.state}` : '';
                    return {
                        number: driver.number,
                        name: driver.name,
                        location: cityState
                    };
                }).filter(d => d !== null);
                
                let tableHtml = `<div class="race-container"><h2>${raceTitle}</h2><table><thead><tr><th class="pos-col">Pos</th><th>Inside Driver</th><th class="pos-col">Pos</th><th>Outside Driver</th></tr></thead><tbody>`;
                
                for (let i = 0; i < drivers.length; i += 2) {
                    const insidePos = i + 1;
                    const outsidePos = i + 2;
                    const insideDriver = drivers[i];
                    const outsideDriver = drivers[i + 1];
                    
                    const insideHtml = insideDriver ? `
                        <span class="driver-number">#${insideDriver.number}</span>
                        <div style="display: inline-block; vertical-align: top;">
                            <span class="driver-name">${insideDriver.name}</span>
                            ${insideDriver.location ? `<span class="driver-location">${insideDriver.location}</span>` : ''}
                        </div>
                    ` : '';
                    
                    const outsideHtml = outsideDriver ? `
                        <span class="driver-number">#${outsideDriver.number}</span>
                        <div style="display: inline-block; vertical-align: top;">
                            <span class="driver-name">${outsideDriver.name}</span>
                            ${outsideDriver.location ? `<span class="driver-location">${outsideDriver.location}</span>` : ''}
                        </div>
                    ` : '';
                    
                    tableHtml += `<tr>
                        <td class="pos-col">${insidePos}</td>
                        <td>${insideHtml}</td>
                        <td class="pos-col">${outsideDriver ? outsidePos : ''}</td>
                        <td>${outsideHtml}</td>
                    </tr>`;
                }
                tableHtml += '</tbody></table></div>';
                printWindow.document.write(tableHtml);
            });
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        
        // V3: Promoter Sheet - Enhanced lineups with stats for announcers (Feature #1)
        function printPromoterSheet(containerId, title, className) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Calculate current points standings
            const classDrivers = state.drivers.filter(d => d.classId === container.dataset.currentClassId || true);
            const standings = classDrivers.map(driver => ({
                driverId: driver.id,
                points: state.seasonPoints[driver.id]?.points || 0,
                featureWins: state.seasonPoints[driver.id]?.featureWins || 0,
                heatWins: state.seasonPoints[driver.id]?.heatWins || 0
            })).sort((a, b) => b.points - a.points);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Promoter Sheet - ' + title + '</title>');
            printWindow.document.write(`<style>
                body{font-family:sans-serif; margin: 20px;} 
                h1,h2,h3{text-align:center; color: #1f2937;} 
                h1{font-size: 2em; margin-bottom: 10px;}
                h2{font-size: 1.5em; color: #f97316; margin-bottom: 20px;}
                .race-container{page-break-inside: avoid; border:2px solid #f97316; padding:15px; margin-bottom: 25px; border-radius: 8px; background: #fff7ed;} 
                table{width:100%; border-collapse:collapse; margin-top: 10px;} 
                td,th{border:1px solid #ddd; padding:10px; text-align:left;} 
                th{background-color:#f97316; color: white; font-weight: bold; text-align: center;} 
                .pos-col{width: 50px; text-align: center; font-weight: bold; font-size: 1.3em;}
                .stats-col{width: 80px; text-align: center; font-size: 1.1em; font-weight: 600;}
                .driver-number{font-size: 1.8em; font-weight: 800; color: #f97316; display: inline-block; margin-right: 10px;}
                .driver-name{font-size: 1.3em; font-weight: 600; color: #1f2937; display: block;}
                .driver-nickname{font-size: 1em; color: #6b7280; font-style: italic; display: block; margin-top: 2px;}
                .driver-location{font-size: 0.9em; color: #6b7280; display: block; margin-top: 3px;}
                .header-note{text-align: center; color: #6b7280; font-size: 0.9em; margin-top: -10px; margin-bottom: 20px;}
            </style>`);
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>üé§ PROMOTER SHEET üé§</h1>`);
            printWindow.document.write(`<h2>${title} - ${document.getElementById('eventDate').value}</h2>`);
            printWindow.document.write(`<p class="header-note">Enhanced lineup with driver stats for announcer reference</p>`);
            printWindow.document.write(`<h3>${className}</h3>`);
            
            const raceContainers = container.querySelectorAll('.bg-gray-50');
            raceContainers.forEach(raceDiv => {
                const raceTitleEl = raceDiv.querySelector('h3') || raceDiv.querySelector('h4');
                if (!raceTitleEl) return;
                const raceTitle = raceTitleEl.textContent;
                
                // Extract driver data with stats
                const driverElements = raceDiv.querySelectorAll('[data-driver-id]');
                const drivers = Array.from(driverElements).map((el, index) => {
                    const driverId = el.dataset.driverId;
                    const driver = state.drivers.find(d => d.id === driverId);
                    if (!driver) return null;
                    
                    const driverStats = state.seasonPoints[driverId] || { points: 0, featureWins: 0, heatWins: 0 };
                    const position = standings.findIndex(s => s.driverId === driverId) + 1;
                    const cityState = (driver.city && driver.state) ? `${driver.city}, ${driver.state}` : '';
                    
                    return {
                        startPos: index + 1,
                        number: driver.number,
                        name: driver.name,
                        nickname: driver.nickname || '',
                        sponsors: driver.sponsors || '', // V4: New field
                        funFacts: driver.funFacts || '', // V4: New field
                        location: cityState,
                        pointsPosition: position > 0 ? `#${position}` : 'N/A',
                        featureWins: driverStats.featureWins,
                        heatWins: driverStats.heatWins
                    };
                }).filter(d => d !== null);
                
                let tableHtml = `<div class="race-container">
                    <h2 style="text-align:left; margin:0 0 15px 0; color:#1f2937;">${raceTitle}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th class="pos-col">Start</th>
                                <th>Driver Info</th>
                                <th class="stats-col">Points<br>Position</th>
                                <th class="stats-col">Feature<br>Wins</th>
                                <th class="stats-col">Heat<br>Wins</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                drivers.forEach(driver => {
                    const nameDisplay = driver.nickname 
                        ? `<span class="driver-name">${driver.name}</span><span class="driver-nickname">"${driver.nickname}"</span>`
                        : `<span class="driver-name">${driver.name}</span>`;
                    
                    const sponsorsDisplay = driver.sponsors 
                        ? `<span class="driver-location" style="color: #059669; font-weight: 500;">ƒë≈∫'ƒΩ Sponsors: ${driver.sponsors}</span>` 
                        : '';
                    
                    const funFactsDisplay = driver.funFacts 
                        ? `<span class="driver-location" style="color: #2563eb; font-weight: 500;">√¢≈õ¬® Fun Fact: ${driver.funFacts}</span>` 
                        : '';
                    
                    tableHtml += `<tr>
                        <td class="pos-col">${driver.startPos}</td>
                        <td>
                            <span class="driver-number">#${driver.number}</span>
                            <div style="display: inline-block; vertical-align: top;">
                                ${nameDisplay}
                                ${driver.location ? `<span class="driver-location">${driver.location}</span>` : ''}
                                ${sponsorsDisplay}
                                ${funFactsDisplay}
                            </div>
                        </td>
                        <td class="stats-col">${driver.pointsPosition}</td>
                        <td class="stats-col">${driver.featureWins}</td>
                        <td class="stats-col">${driver.heatWins}</td>
                    </tr>`;
                });
                
                tableHtml += '</tbody></table></div>';
                printWindow.document.write(tableHtml);
            });
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        
        function printFullResults(containerId, title, className) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<style>body{font-family:sans-serif; margin: 20px;} h1,h2,h3,h4{ margin: 10px 0; } .race-container{page-break-inside: avoid; border:1px solid #ccc; padding:10px; margin-bottom: 20px;} ol{ padding-left: 20px; } .flex{display: flex; justify-content: space-between;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>${title} - ${document.getElementById('eventDate').value}</h1>`);
            printWindow.document.write(`<h2>${className}</h2>`);
            const contentToPrint = container.cloneNode(true);
            contentToPrint.querySelectorAll('button, select, input').forEach(el => el.remove());
            printWindow.document.write(contentToPrint.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // V4: Print Payout Sheet with signature lines for driver signatures
        function printPayoutSheet() {
            const classId = document.getElementById('raceResultsClassSelect').value;
            if (!classId) {
                showInfoModal('No Class Selected', 'Please select a class to print the payout sheet.');
                return;
            }
            
            const className = state.classes.find(c => c.id === classId)?.name || 'Unknown Class';
            const eventDate = document.getElementById('eventDate').value;
            const featureResults = state.featureResults[classId];
            
            if (!featureResults || !featureResults.results || featureResults.results === 'rainout') {
                showInfoModal('No Results', 'No feature results available for this class. Complete the feature race first.');
                return;
            }
            
            // Get payout structure for this class
            const classStatus = state.completedRegistrations.find(c => c.id === classId);
            const payoutStructureId = classStatus?.payoutStructure;
            const payoutStructure = payoutStructureId ? state.payoutStructures.find(s => s.id === payoutStructureId) : null;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Payout Sheet - ' + className + '</title>');
            printWindow.document.write(`<style>
                body { font-family: sans-serif; margin: 20px; }
                h1, h2 { text-align: center; color: #1f2937; }
                h1 { font-size: 2em; margin-bottom: 10px; }
                h2 { font-size: 1.3em; color: #f97316; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 2px solid #333; padding: 12px 8px; text-align: left; }
                th { background-color: #f97316; color: white; font-weight: bold; text-align: center; }
                .pos-col { width: 60px; text-align: center; font-weight: bold; font-size: 1.2em; }
                .num-col { width: 70px; text-align: center; font-weight: bold; }
                .location-col { width: 180px; }
                .points-col { width: 70px; text-align: center; }
                .earnings-col { width: 90px; text-align: center; font-weight: bold; }
                .signature-col { width: 200px; }
                .signature-line { border-bottom: 1px solid #333; min-height: 30px; margin-top: 10px; }
                .instructions { text-align: center; color: #6b7280; font-size: 0.9em; margin: 20px 0; border: 2px solid #f97316; padding: 15px; background: #fff7ed; }
                .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 0.85em; }
            </style>`);
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>üí∞ DRIVER PAYOUT SHEET üí∞</h1>`);
            printWindow.document.write(`<h2>${className} - ${eventDate}</h2>`);
            printWindow.document.write(`<p class="instructions"><strong>DRIVER SIGNATURE REQUIRED:</strong> All drivers must sign below to acknowledge receipt of payout. This document is for official track records.</p>`);
            
            // Build the payout table
            let tableHtml = `<table>
                <thead>
                    <tr>
                        <th class="pos-col">Position</th>
                        <th class="num-col">Car #</th>
                        <th>Driver Name</th>
                        <th class="location-col">City, State</th>
                        <th class="points-col">Points<br>Earned</th>
                        <th class="earnings-col">Payout</th>
                        <th class="signature-col">Signature</th>
                    </tr>
                </thead>
                <tbody>`;
            
            // Sort results by position
            const sortedResults = [...featureResults.results].sort((a, b) => a.position - b.position);
            
            sortedResults.forEach(result => {
                const driver = state.drivers.find(d => d.id === result.driverId);
                if (!driver) return;
                
                const location = (driver.city && driver.state) ? `${driver.city}, ${driver.state}` : '';
                
                // Calculate points earned
                const heatResults = state.heatResults[classId] || {};
                const allHeatResultsFlat = Object.values(heatResults).flat();
                const heatResult = allHeatResultsFlat.find(r => r.driverId === result.driverId);
                const classStatus = state.completedRegistrations.find(c => c.id === classId);
                const skippedHeats = classStatus?.skippedHeats || false;
                
                let pointsEarned = 0;
                if (!skippedHeats && heatResult) {
                    pointsEarned += (state.pointSettings.heat[heatResult.position - 1] || 0);
                }
                pointsEarned += (state.pointSettings.feature[result.position - 1] || 0);
                
                // Apply points multiplier if applicable
                const pointsOption = classStatus?.pointsOption || 'normal';
                const pointMultiplier = (pointsOption === 'double') ? 2 : (pointsOption === 'none') ? 0 : 1;
                pointsEarned *= pointMultiplier;
                
                // Get payout amount
                let payoutAmount = '$0.00';
                if (payoutStructure && result.position <= payoutStructure.payouts.length) {
                    const amount = payoutStructure.payouts[result.position - 1] || 0;
                    payoutAmount = amount > 0 ? `$${amount.toFixed(2)}` : '$0.00';
                }
                
                tableHtml += `<tr>
                    <td class="pos-col">${result.position}</td>
                    <td class="num-col">#${driver.number}</td>
                    <td>${driver.name}</td>
                    <td class="location-col">${location}</td>
                    <td class="points-col">${pointsEarned}</td>
                    <td class="earnings-col">${payoutAmount}</td>
                    <td class="signature-col"><div class="signature-line"></div></td>
                </tr>`;
            });
            
            tableHtml += '</tbody></table>';
            printWindow.document.write(tableHtml);
            
            printWindow.document.write(`<p class="footer">Official Track Record - 35 Raceway Park<br>Track Official Signature: ___________________________ Date: ___________</p>`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function printPoints() {
            const pointsTable = document.querySelector('#points table');
            const className = document.getElementById('pointsClassSelect').selectedOptions[0].text;
            if (!pointsTable) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Championship Points</title>');
            printWindow.document.write('<style>body{font-family:sans-serif; margin: 20px;} h1,h2{text-align:center;} table{width:100%; border-collapse:collapse; margin-top: 20px;} td,th{border:1px solid #ddd; padding:8px; text-align:left;} th{background-color:#f2f2f2;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>Championship Points</h1><h2>${className} - As of ${new Date().toLocaleDateString()}</h2>`);
            
            const tableClone = pointsTable.cloneNode(true);
            tableClone.querySelectorAll('tr').forEach(row => row.deleteCell(-1)); // Remove 'Actions' column
            printWindow.document.write(tableClone.outerHTML);

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // --- Test Data Generation ---
        function generateTestData() {
            showConfirmationModal('Generate 2025 Season Data?', 'This will add all drivers and classes from the 35raceway.com 2025 roster. Existing data will not be affected.',
                () => {
                    const btn = document.getElementById('generateTestDataBtn');
                    btn.disabled = true;
                    btn.textContent = 'Generating...';

                    setTimeout(() => {
                        const classes = {
                            "KELLY MAE'S HOBBY STOCKS": ["ROBERT BINDER SR,01", "CAMERON CARTER,29C", "TOBY COTTRILL,18", "AUSTIN WITHROW,78", "CURTIS CLEMMONS,27C", "DAVE CALDWELL,3D", "CHARLES MECUM,23", "CHRIS WILSON,62X", "ISAC PAYNE,711", "AUSTIN HAWKINS,21", "MICHAEL FULTZ,32", "ROBERT BINDER JR,8", "WILLAM EWING,51", "MAT LARGE,19", "WILLIAM LUCAS,32", "DALE BENNETT,32X", "BAILEY MILLER,22B", "BRAD MILLER,22B", "DANIKA SPROUSE,18", "JONATHAN HARROP,M57", "JOHN BINDER,5", "CHRIS BENSON,18", "TIM HOWARD,18X", "DAVID EVANS,11", "DEREK HAWK,12", "RICK BALASICO JR,19", "KENNY COLEMAN,19", "RICK BALASICO SR,23", "BRIAN SALMONS,21B", "KELLY JAMISON,21"],
                            "COLUMBUS CLIMATE CONTROL TRUCKS": ["ROBERT ADAMS,15", "CHRIS PEUGEOT,12", "DANIEL MCDADE,049", "ZACH NEAL,33", "RANDY TAYLOR,22", "WAYNE MCDADE,37", "SLADE MACK,12M", "RANDY STECK,10", "BILL HALL,13", "TIM LYONS,707", "ROB STAMBAUGH,64", "EDWARD HUNSICKER,13", "CHIP MACK,1", "ROLLY HEYDER JR,10", "BRANDON FURNISS,13", "CASEY CORDONNIER,4M", "BJ JACKSON,28", "JOEY HEYDER,8", "DUSTIN RATLIFF,5*", "CURTIS HEISER,9C", "JERRY HOPKINS,729", "JUSTIN SLYGH,06"],
                            "CLAYS PERFORMANCE ELECTRIC UMP MODIFIEDS": ["ERIC KINNEY II,77", "MARK DICKSON,0", "PETE BRUNTON,06", "RYAN CROWE,99", "BRIAN WHITEMAN,52", "DUSTIN HENDERSON,14D", "GLENN KEATON,G2", "TERRY HUMPHREY,1", "ERIC ARLEDGE,65", "NICK BRUNTON,2", "ADAM COLLEY,11", "JADEN RITCHEA,77J", "MIKE CONKLE,11J", "TRAVIS DICKSON,RV1", "TJ ROUSH,T8", "ROB STAMBAUGH,67", "JP ROBERTS,9R", "BOBBY BAGLEY,5", "KEVIN WILLS,9K", "EVAN SEITZ,22", "BRIAN SKAGGS,20", "AUSTIN SELF,23Z", "SETH CHANEY,99C", "MASON CANTER,9T", "JEFF CONRAD,62C", "DANNY MOORE,29", "JEREMY BLAKE,B4", "DANNY FERGUSON,CR1", "MARK JAMISON,42P", "CLARK VAN HOUTEN,5", "RYAN SKINNER,32", "TANNER RITCHEA,77T", "JOSH THOMAS,96", "DUSTY BOLEY,75", "DUSTIN GILBER,8", "WILLIAM HARRIS,H66", "DANIEL SANCHEZ,463", "CHAZ DAWSON,33", "BLAKE SHEETS,3B", "JUSTIN MULLER,18M", "WILLIAM CALDWELL,W1", "DAVE WALTERS,4W", "ROBIN OURS,10R"],
                            "4 CYL STOCKS": ["CHARLES DOZIER,319", "DONNIE VASBINDER,136", "RALPH BROWN,18B", "TOMMY GORMAN JR,26", "CHRIS BROWN,18", "JAMES DEAL,38", "DYLAN VANCE,803", "BRANDON DUNAWAY,9", "WILL DEAL,03", "CHRIS GOBLE,614", "ZACH FULLEN,6", "MATTHEW DUNAWAY,44X", "MAT BROWN,315", "TEDDY LOWERY,75L", "JOSH QUEEN,50", "RODNEY RITTENHOUSE,44", "FLOYD SIMMONS,13", "TOMMY KELLOUGH,77", "DELBERT QUEEN,05", "JIMMY DUNAWAY,3", "NATE DUNAWAY,8", "SHONDRICK STEINER,19", "DANIEL MCDADE,049", "ANDREW ZIMMERMAN,9Z", "JORDAN HAY,25", "HAYLEE DEAL,904", "CHRIS YOAK,11", "TERRY DUNAWAY,5", "JEREMY QUEEN,05", "CHRIS RITTENHOUSE,9X", "ERIC MCINTYRE,6", "SHANE RITTENHOUSE,44", "BRENTON COOPER,7B", "BRANDON KING,33J", "TIM BOWEN,126", "RANDY BURNS,1", "MEGAN LOWERY,75", "CHRIS RAWLINS,75", "DONNIE HORNE,4L"],
                            "CLAYS PERFORMANCE CONST SPORT MODS": ["JUSTIN MULLEN,18M", "ETHAN WEBB,4", "JARRET MCCARLEY,1", "PETE BRUNTON,06", "DAN DISINGER,27", "BRANDON FURNISS,32", "KEVIN WILLS,9K", "CODY PRICE,10P", "WILLIAM CALDWELL,W1", "WILLIE STOUT,11", "JERRY HOPKINS,729", "KALEE CROWE,33C", "PJ KELLY,38", "CHRIS MATHENY,36C", "ERIC MCINTYRE,33", "REECE BLOOMFIELD,233", "RYAN SEXTON,21R", "ERIC KINNEY II,77", "RIDGE COLWELL,804", "REED BISHOP,RC10", "JEFF GILLMAN,60G", "DAVID HOWARD,0", "DUSTIN HIGGINBOTHAM,33H", "DEEGEN BLOOMFIELD,111", "KASEY RANKIN,K9", "COLE JAMISON,51C", "ETHAN ECKELBARGER,57", "NICK BRUNTON,6", "DANNY JONES,1X", "CONNER MCKENZIE,33", "SHAWN DONAHUE,5", "NOAH BLAKE,B4", "COLE FLESHER,26", "MICHAEL STRATTON,86", "ALEX BROUGHTON,16X", "CHARLES LYKINS,45", "JAKE CASSEL,24", "TUCKER ADAMS,32T", "TEDDY THAYER,41T", "PAT GARRETT,3", "FRED HITTLE,11X", "DALLAS PICKELHEIMER,11X", "MIKIE HOWARD,16", "JOHN GIBSON,32K", "KURT DUNAWAY,10D", "TRAVIS DICKSON,2R", "NIC GREEN,11G", "BRIAN THORNBERRY II,T6", "JOSH GIBSON,2G", "TYLER WEBB,19", "ADAM LAWSON,79", "JASON THAYER,11X", "CODY WEST,75", "RJ PERKINS,2R"],
                            "COMPACTS": ["JEFF CARMEAN,406", "ROBERT BINDER JR,8", "JORDAN MORGAN,14", "MCKENZIE BALASICO,1K", "RICHARD BALASICO,269", "RICK BALASICO SR,1K", "AUSTIN GATWOOD,2", "TJ SECREST,26", "LARRY LUCAS,5", "LES STEPHENSON,12", "JAMIE ROCK,13", "KEVIN WILLS,9", "MEGHEN SEASRAVES,51M", "BRYSON BALL,71", "BAILEY MILLER,22B", "BRANDON SLONE,36", "ERIC MCINTYRE,01", "TJ STICKEL,12", "TODD WILLS,2", "MICHAEL SEITFERT,7L", "BROCK SEARLS,97S", "MICHAEL DARSEY,14X", "ROBERT BINDER SR,01", "TRISTEN MILLER,11W", "TREY GREGORY,753", "BRET BALL,T3", "DUSTIN HIGGINBOTHAM,13", "DAYTONA HENSLEY,23", "CLINT COX,469", "GARRETT PITTENGER,A25", "KELSEA GUSSLER,86", "CODY MASSENGILL,T3", "RYAN COOK,416", "LOGAN BUTLER,52B", "DAVID LUCAS,59", "JOE BUTLER,33B", "MIKE HONCHO,1"],
                            "MOD LITES": ["CHRIS RITTENHOUSE,44R", "STORM SHOEMAKER,09", "DYLAN RITTENHOUSE,25", "PHIL SMITH,024", "VONLEY JORDAN III,95J", "DAVID SEITZ,22", "ANDREW WITT,30D", "COLEMAN WITT,29C", "AARON PENDLETON,1Y", "LOGAN PATRICK,07", "CHIP BAILEY,24", "KARA KIMES,1/2", "SHAWN WINCE,48", "CHRIS JONES,319", "DAVID INNES,18", "RANDY ARMES,33", "TYLER EICK,71", "ED LANHAM,63", "TOMMY BIGHAM,T48", "COLIN WINCE,C48", "NICK CASTOR,49"]
                        };

                        for (const className in classes) {
                            let classObj = state.classes.find(c => c.name === className);
                            if (!classObj) {
                                classObj = { id: generateUniqueId(), name: className };
                                state.classes.push(classObj);
                            }
                            
                            classes[className].forEach(driverInfo => {
                                const [name, number] = driverInfo.split(',');
                                const existingDriver = state.drivers.find(d => d.name === name.trim() && d.classId === classObj.id);
                                if (!existingDriver) {
                                    // V3: Include all new fields with default values
                                    const newDriver = {
                                        id: generateUniqueId(),
                                        name: name.trim(),
                                        nickname: '', // V3: Empty by default
                                        number: number.trim(),
                                        license: 'N/A',
                                        phone: 'N/A',
                                        address: '', // V3: Empty by default
                                        city: '', // V3: Empty by default
                                        state: '', // V3: Empty by default
                                        classId: classObj.id
                                    };
                                    state.drivers.push(newDriver);
                                    
                                    // V3: Initialize season points with all stats
                                    if (!state.seasonPoints[newDriver.id]) {
                                        state.seasonPoints[newDriver.id] = {
                                            points: 0,
                                            starts: 0,
                                            featureWins: 0,
                                            heatWins: 0,
                                            top5s: 0,
                                            top10s: 0
                                        };
                                    }
                                }
                            });
                        }

                        saveState();
                        renderAll();
                        btn.disabled = false;
                        btn.textContent = 'Generate 2025 Season Data';
                        showInfoModal("Success", "2025 season data has been generated! All drivers added with V3 fields.");
                    }, 10);
                }
            );
        }

        // --- Event Listeners and Initial Load ---
        function setupRaceManagerApp() {
            const eventDatePicker = document.getElementById('eventDate');
            eventDatePicker.value = localStorage.getItem('raceManagerEventDate') || new Date().toISOString().split('T')[0];
            loadState();
            setupTabs();
            setupDriverModal();
            renderAll();
            renderPointSettings();
            
            eventDatePicker.addEventListener('change', (e) => {
                localStorage.setItem('raceManagerEventDate', e.target.value);
                window.location.reload();
            });

            document.getElementById('createClassBtn').addEventListener('click', () => {
                const input = document.getElementById('newClassName');
                createClass(input.value);
                input.value = '';
            });
            document.getElementById('generateTestDataBtn').addEventListener('click', generateTestData);
            document.getElementById('registrationClassSelect').addEventListener('change', (e) => {
                const isCompleted = e.target.options[e.target.selectedIndex].dataset.completed === 'true';
                document.getElementById('completeRegistrationBtn').disabled = isCompleted || !e.target.value;
                renderRegistrationForClass(e.target.value);
            });
            document.getElementById('driverClassFilter').addEventListener('change', renderDrivers);
            document.getElementById('completeRegistrationBtn').addEventListener('click', completeRegistration);
            
            const manualHeatCountInput = document.getElementById('manualHeatCount');
            manualHeatCountInput.addEventListener('input', updateHeatBreakdown);

            function updateHeatBreakdown() {
                const breakdownText = document.getElementById('heatBreakdownText');
                const driverCount = parseInt(document.getElementById('registeredDriverCount').textContent) || 0;
                const heatCount = parseInt(manualHeatCountInput.value) || 0;
                if (driverCount === 0 || heatCount <= 0) {
                    breakdownText.textContent = '';
                    updateBMainBreakdown();
                    return;
                }
                const base = Math.floor(driverCount / heatCount);
                const remainder = driverCount % heatCount;
                if (remainder === 0) {
                    breakdownText.textContent = `${heatCount} heats of ${base} drivers.`;
                } else {
                    breakdownText.textContent = `${remainder} heats of ${base + 1}, ${heatCount - remainder} heats of ${base}.`;
                }
                updateBMainBreakdown();
            }

            function updateBMainBreakdown() {
                const bMainText = document.getElementById('bMainBreakdownText');
                const bMainEnabled = document.getElementById('enableBMain').checked;

                if (!bMainEnabled) {
                    bMainText.textContent = '';
                    return;
                }

                const featureCount = parseInt(document.getElementById('featureStartCount').value) || 0;
                const heatTransfer = parseInt(document.getElementById('heatTransferCount').value) || 0;
                const heatCount = parseInt(document.getElementById('manualHeatCount').value) || 0;
                
                if (featureCount <= 0 || heatTransfer <= 0 || heatCount <= 0) {
                     bMainText.textContent = '';
                    return;
                }
                
                const directTransfers = heatTransfer * heatCount;
                const bMainTransfers = Math.max(0, featureCount - directTransfers);
                
                bMainText.textContent = `Transfers from B-Main: ${bMainTransfers}`;
            }

            document.getElementById('raceSetupClassSelect').addEventListener('change', (e) => {
                const id = e.target.value;
                document.getElementById('raceSetupOptions').classList.toggle('hidden', !id);
                document.getElementById('lineupSetupContainer').classList.toggle('hidden', !id);
                document.getElementById('generateLineupsBtn').classList.toggle('hidden', !id);
                renderRaceSetupLineup(id);
                
                const reg = state.completedRegistrations.find(r => r.id === id);
                const generated = reg && reg.heatsGenerated;
                
                const driverCount = reg ? reg.registeredDrivers.length : 0;
                document.getElementById('registeredDriverCount').textContent = driverCount;
                manualHeatCountInput.value = '';
                document.getElementById('skipHeatsCheckbox').checked = false;
                updateHeatBreakdown();
                updateBMainBreakdown();
                handleSkipHeatsToggle();
                
                // V3: Update show-up points display
                document.getElementById('showUpPointsDisplay').textContent = state.pointSettings.showUpPoints || 0;
                
                // Restore payout structure for this class if it was previously set
                const payoutSelect = document.getElementById('payoutStructureSelect');
                if (reg && reg.payoutStructure) {
                    payoutSelect.value = reg.payoutStructure;
                } else {
                    payoutSelect.value = '';
                }

                document.getElementById('generateLineupsBtn').disabled = !id || generated;
                document.getElementById('generateLineupsBtn').textContent = generated ? 'Lineups Generated' : 'Generate Lineups';
                document.querySelectorAll('#raceSetupOptions input, #lineupSetupContainer input, #randomPillDrawBtn').forEach(el => el.disabled = generated);
            });
            
            function handleSkipHeatsToggle() {
                const skipHeats = document.getElementById('skipHeatsCheckbox').checked;
                document.getElementById('standardHeatSetup').classList.toggle('disabled', skipHeats);
                document.getElementById('bMainSetupContainer').classList.toggle('disabled', skipHeats);
                const generateBtn = document.getElementById('generateLineupsBtn');
                generateBtn.textContent = skipHeats ? 'Generate Feature Lineup' : 'Generate Heat Races';
            }
            document.getElementById('skipHeatsCheckbox').addEventListener('input', handleSkipHeatsToggle);


            document.getElementById('randomPillDrawBtn').addEventListener('click', randomPillDraw);
            document.getElementById('generateLineupsBtn').addEventListener('click', generateLineups);

            // Delegated listener for dynamically created buttons
            document.getElementById('heatLineupsContainer').addEventListener('click', (e) => {
                if (e.target.classList.contains('save-heat-btn')) {
                    saveHeatResults(e);
                } else if (e.target.classList.contains('no-results-btn')) {
                    const heatContainer = e.target.closest('[data-heat-index]');
                    const heatIndex = heatContainer.dataset.heatIndex;
                    const classId = document.getElementById('heatRacesClassSelect').value;
                    
                    // V3: Suspend the event instead of permanent rainout
                    showConfirmationModal('Suspend Due to Weather?', `This will suspend Heat ${parseInt(heatIndex) + 1} due to weather. The event can be resumed and completed on another date. All current progress will be saved.`, () => {
                        if (!state.heatResults[classId]) state.heatResults[classId] = {};
                        state.heatResults[classId][`heat_${heatIndex}`] = 'rainout'; // Mark this heat as rained out
                        
                        // V3: Mark class as suspended
                        if (!state.suspendedClasses) state.suspendedClasses = {};
                        state.suspendedClasses[classId] = {
                            status: 'suspended',
                            suspendedAt: new Date().toISOString(),
                            reason: `Weather during Heat ${parseInt(heatIndex) + 1}`,
                            currentPhase: 'heats',
                            completedHeats: Object.keys(state.heatResults[classId] || {}).length
                        };
                        
                        saveState();
                        renderHeatRaces(classId);
                        renderHeatRacesClasses();
                        showInfoModal('Event Suspended', `This class has been suspended and can be resumed on another race date. All progress has been saved.`);
                    });
                }
            });
            
            document.getElementById('bMainContainer').addEventListener('click', (e) => {
                if (e.target.classList.contains('no-results-btn')) {
                    const classId = document.getElementById('bMainClassSelect').value;
                    
                    // V3: Suspend the event instead of permanent rainout
                    showConfirmationModal('Suspend Due to Weather?', 'This will suspend the B-Main due to weather. The event can be resumed and completed on another date. All current progress will be saved.', () => {
                        state.bMainResults[classId] = { results: 'rainout' };
                        
                        // V3: Mark class as suspended
                        if (!state.suspendedClasses) state.suspendedClasses = {};
                        state.suspendedClasses[classId] = {
                            status: 'suspended',
                            suspendedAt: new Date().toISOString(),
                            reason: 'Weather during B-Main',
                            currentPhase: 'bmain',
                            heatsCompleted: true
                        };
                        
                        saveState();
                        renderBMain(classId);
                        renderNextRaceClasses('bMain');
                        showInfoModal('Event Suspended', `This class has been suspended and can be resumed on another race date. All progress has been saved.`);
                    });
                } else if (e.target.classList.contains('save-bmain-btn')) {
                    saveBMainResults(e);
                }
            });

            document.getElementById('featureContainer').addEventListener('click', (e) => {
                if (e.target.classList.contains('no-results-btn')) {
                    const classId = document.getElementById('featureClassSelect').value;
                    
                    // V3: Suspend the event instead of permanent rainout
                    showConfirmationModal('Suspend Due to Weather?', 'This will suspend the Feature due to weather. The event can be resumed and completed on another date. All current progress will be saved.', () => {
                        state.featureResults[classId] = { results: 'rainout' };
                        
                        // V3: Mark class as suspended
                        if (!state.suspendedClasses) state.suspendedClasses = {};
                        state.suspendedClasses[classId] = {
                            status: 'suspended',
                            suspendedAt: new Date().toISOString(),
                            reason: 'Weather during Feature',
                            currentPhase: 'feature',
                            heatsCompleted: true,
                            bMainCompleted: state.bMainResults[classId] ? true : false
                        };
                        
                        saveState();
                        renderFeature(classId);
                        renderNextRaceClasses('feature');
                        showInfoModal('Event Suspended', `This class has been suspended and can be resumed on another race date. All progress has been saved.`);
                    });
                } else if (e.target.classList.contains('save-feature-btn')) {
                    saveFeatureResults(e);
                }
            });
            
            // V4: Tech Inspection checkbox handler - enable inputs directly (don't re-render)
            document.getElementById('featureContainer').addEventListener('change', (e) => {
                if (e.target.id && e.target.id.startsWith('techInspection-')) {
                    const classId = e.target.id.replace('techInspection-', '');
                    const isChecked = e.target.checked;
                    
                    // Find all position inputs for this feature and enable/disable them
                    const inputs = document.querySelectorAll(`input.v3-position-input[data-race-id="feature-${classId}"]`);
                    inputs.forEach(input => {
                        input.disabled = !isChecked;
                    });
                    
                    // Find and toggle the warning message if it exists
                    const positionsContainer = document.querySelector(`#v3-positions-feature-${classId}`);
                    if (positionsContainer && positionsContainer.parentElement) {
                        const warning = positionsContainer.parentElement.querySelector('p.text-red-600');
                        if (warning) {
                            warning.style.display = isChecked ? 'none' : 'block';
                        }
                    }
                }
            });

            document.getElementById('finalizeHeatsBtn').addEventListener('click', finalizeHeatResultsAndSetNextLineup);
            
            // V4: Reset to Registration functionality
            document.getElementById('resetToRegistrationBtn').addEventListener('click', () => {
                const classId = document.getElementById('resetToRegistrationBtn').dataset.classId;
                if (!classId) return;
                
                const className = state.classes.find(c => c.id === classId)?.name || 'this class';
                
                showConfirmationModal(
                    'Reset to Registration?',
                    `This will completely reset ${className} back to an unregistered state. All race setup, heat lineups, and registered drivers will be cleared. You can then start fresh with driver registration. Continue?`,
                    () => {
                        // V4: COMPLETE reset - remove ALL data for this class
                        
                        // Clear heats data
                        delete state.heats[classId];
                        delete state.heatResults[classId];
                        
                        // Clear B-Main and Feature data
                        delete state.bMains[classId];
                        delete state.bMainResults[classId];
                        delete state.features[classId];
                        delete state.featureResults[classId];
                        
                        // Clear registration state
                        delete state.registrations[classId];
                        
                        // COMPLETELY REMOVE from completedRegistrations array
                        // This unlocks the class for fresh registration
                        state.completedRegistrations = state.completedRegistrations.filter(cr => cr.id !== classId);
                        
                        // Save state first
                        saveState();
                        
                        // Render all to update UI (this rebuilds all dropdowns)
                        renderAll();
                        
                        // Switch to registration tab
                        switchTab('registration');
                        
                        // Small delay to let tab render, then select the class
                        setTimeout(() => {
                            const selectEl = document.getElementById('registrationClassSelect');
                            if (selectEl) {
                                selectEl.value = classId;
                                // Explicitly render the registration panel with updated state
                                renderRegistrationForClass(classId);
                                // Enable the Complete Registration button
                                document.getElementById('completeRegistrationBtn').disabled = false;
                            }
                        }, 150);
                        
                        // Show success message after a delay
                        setTimeout(() => {
                            showInfoModal('Reset Complete', `${className} has been completely reset. The class is now unlocked and ready for fresh driver registration. Click on drivers to add them, then click "Complete Registration" when ready.`);
                        }, 250);
                    }
                );
            });
            
            ['enableBMain', 'featureStartCount', 'heatTransferCount'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateBMainBreakdown);
            });

            function getClassNameFromSelect(selectId) {
                const select = document.getElementById(selectId);
                return select.options[select.selectedIndex]?.text || '';
            }

            document.getElementById('printHeatsBtn').addEventListener('click', () => printLineups('heatLineupsContainer', 'Heat Race Lineups', getClassNameFromSelect('heatRacesClassSelect')));
            
            // V3: Promoter Sheet button (Feature #1)
            document.getElementById('printPromoterSheetBtn').addEventListener('click', () => {
                const container = document.getElementById('heatLineupsContainer');
                const classId = document.getElementById('heatRacesClassSelect').value;
                if (!classId) {
                    showInfoModal('No Class Selected', 'Please select a class first.');
                    return;
                }
                container.dataset.currentClassId = classId; // Store for standings calculation
                printPromoterSheet('heatLineupsContainer', 'Heat Race Lineups', getClassNameFromSelect('heatRacesClassSelect'));
            });
            
            document.getElementById('heatRacesClassSelect').addEventListener('change', e => {
                renderHeatRaces(e.target.value);
                // V3: Show/hide reset button based on whether class has heats
                const classId = e.target.value;
                const resetBtn = document.getElementById('resetToRegistrationBtn');
                if (classId && state.heats[classId]) {
                    resetBtn.classList.remove('hidden');
                } else {
                    resetBtn.classList.add('hidden');
                }
            });
            
            // V3: Reset to Registration button handler (Feature #2)
            
            document.getElementById('bMainClassSelect').addEventListener('change', e => renderBMain(e.target.value));
            document.getElementById('finalizeBMainBtn').addEventListener('click', finalizeBMain);
            document.getElementById('featureClassSelect').addEventListener('change', e => renderFeature(e.target.value));
            document.getElementById('finalizeFeatureBtn').addEventListener('click', finalizeFeatureAndAwardPoints);
            
            // V3: Handle custom invert input visibility
            document.querySelectorAll('input[name="invertOption"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const customInput = document.getElementById('customInvertNum');
                    const classId = document.getElementById('featureClassSelect').value;
                    
                    // Show/hide custom input
                    if (e.target.value === 'custom') {
                        customInput.style.display = 'inline-block';
                        customInput.classList.remove('hidden');
                        
                        // Wait for user to enter number
                        const applyCustom = () => {
                            const customValue = parseInt(customInput.value);
                            const lineupLength = state.features[classId]?.lineup?.length || 0;
                            
                            if (!customValue || customValue < 2) {
                                showInfoModal('Invalid Input', 'Please enter a number of 2 or greater.');
                                return;
                            }
                            if (customValue > lineupLength) {
                                showInfoModal('Invalid Input', `Cannot invert more than ${lineupLength} positions (total field size).`);
                                return;
                            }
                            
                            state.features[classId].invert = customValue.toString();
                            saveState();
                            renderFeature(classId);
                        };
                        
                        // Apply on Enter key or blur
                        customInput.addEventListener('keypress', function handler(e) {
                            if (e.key === 'Enter') {
                                applyCustom();
                                customInput.removeEventListener('keypress', handler);
                            }
                        });
                        customInput.addEventListener('blur', function handler() {
                            if (customInput.value) applyCustom();
                            customInput.removeEventListener('blur', handler);
                        });
                        
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                        customInput.classList.add('hidden');
                        customInput.value = '';
                        
                        if (classId && state.features[classId]) {
                            state.features[classId].invert = e.target.value;
                            saveState();
                            renderFeature(classId);
                        }
                    }
                });
            });
            
            document.getElementById('resetInvertBtn').addEventListener('click', () => {
                const classId = document.getElementById('featureClassSelect').value;
                const customInput = document.getElementById('customInvertNum');
                if (classId && state.features[classId]) {
                    state.features[classId].invert = '0';
                    customInput.style.display = 'none';
                    customInput.classList.add('hidden');
                    customInput.value = '';
                    saveState();
                    renderFeature(classId);
                }
            });

            document.getElementById('printBMainBtn').addEventListener('click', () => printLineups('bMainContainer', 'B-Main Lineup', getClassNameFromSelect('bMainClassSelect')));
            document.getElementById('printBMainPromoterSheetBtn').addEventListener('click', () => printPromoterSheet('bMainContainer', 'B-Main', getClassNameFromSelect('bMainClassSelect'))); // V4: New
            document.getElementById('printFeatureBtn').addEventListener('click', () => printLineups('featureContainer', 'Feature Lineup', getClassNameFromSelect('featureClassSelect')));
            document.getElementById('printFeaturePromoterSheetBtn').addEventListener('click', () => printPromoterSheet('featureContainer', 'Feature Race', getClassNameFromSelect('featureClassSelect'))); // V4: New
            document.getElementById('printResultsBtn').addEventListener('click', () => printFullResults('raceResultsContainer', 'Full Race Results', getClassNameFromSelect('raceResultsClassSelect')));
            document.getElementById('printPayoutSheetBtn').addEventListener('click', printPayoutSheet); // V4: Payout sheet
            document.getElementById('printPointsBtn').addEventListener('click', printPoints);
            
            // V3: CSV Export button handlers (Feature #8)
            document.getElementById('exportHeatLineupsBtn').addEventListener('click', exportHeatLineups);
            document.getElementById('exportHeatResultsBtn').addEventListener('click', exportHeatResults);
            document.getElementById('exportBMainLineupBtn').addEventListener('click', exportBMainLineup);
            document.getElementById('exportBMainResultsBtn').addEventListener('click', exportBMainResults);
            document.getElementById('exportFeatureLineupBtn').addEventListener('click', exportFeatureLineup);
            document.getElementById('exportFeatureResultsBtn').addEventListener('click', exportFeatureResults);
            document.getElementById('exportPointsBtn').addEventListener('click', exportPointsStandings);
            document.getElementById('exportPayoutsBtn').addEventListener('click', exportPayoutSummary);
            
            document.getElementById('printHistoryBtn').addEventListener('click', () => {
                const className = getClassNameFromSelect('historyClassSelect');
                const selectedDateEl = document.querySelector('#historyDateList .bg-orange-100');
                if (!selectedDateEl) {
                    showInfoModal('Error', 'Please select a date from the list to print.');
                    return;
                }
                const dateStr = selectedDateEl.textContent;
                
                const container = document.getElementById('historyResultsContainer');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Historical Race Results</title>');
                printWindow.document.write('<style>body{font-family:sans-serif; margin: 20px;} h1,h2,h3,h4{ margin: 10px 0; } .flex{display: flex; justify-content: space-between;} .race-container{page-break-inside: avoid; border:1px solid #ccc; padding:10px; margin-bottom: 20px;} .space-y-1 > *+*{margin-top: 0.25rem;}</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h1>Historical Race Results - ${dateStr}</h1>`);
                printWindow.document.write(`<h2>${className}</h2>`);
                const contentToPrint = container.cloneNode(true);
                contentToPrint.querySelectorAll('button, select, input').forEach(el => el.remove());
                printWindow.document.write(contentToPrint.innerHTML);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            });

            document.getElementById('savePointsBtn').addEventListener('click', savePointSettings);
            document.getElementById('pointsClassSelect').addEventListener('change', e => renderPointsPage(e.target.value));
            document.getElementById('raceResultsClassSelect').addEventListener('change', e => renderRaceResults(e.target.value));
            document.getElementById('historyClassSelect').addEventListener('change', e => renderHistoryDates(e.target.value));
            
            // V4: Payout Management functionality
            document.getElementById('payoutClassFilter').addEventListener('change', renderPayouts);
            document.getElementById('payoutDriverSearch').addEventListener('input', renderPayouts);
            
            // V4: Weekend Notes functionality
            document.getElementById('weekendNotesBtn').addEventListener('click', () => {
                const eventDate = document.getElementById('eventDate').value;
                if (!eventDate) {
                    showInfoModal('No Date Selected', 'Please select an event date first.');
                    return;
                }
                document.getElementById('weekendNotesDate').textContent = eventDate;
                document.getElementById('weekendNotesText').value = state.weekendNotes || '';
                showModal('weekendNotesModal');
            });
            
            document.getElementById('weekendNotesModalCancelBtn').addEventListener('click', () => hideModal('weekendNotesModal'));
            
            document.getElementById('weekendNotesForm').addEventListener('submit', (e) => {
                e.preventDefault();
                state.weekendNotes = document.getElementById('weekendNotesText').value.trim();
                saveState();
                hideModal('weekendNotesModal');
                showInfoModal('Notes Saved', 'Your weekend notes have been saved with this event\'s history.');
            });
            
            // V4: Race History button and modal
            document.getElementById('viewHistoryBtn').addEventListener('click', () => {
                renderRaceHistory();
                showModal('raceHistoryModal');
            });
            
            document.getElementById('raceHistoryModalCloseBtn').addEventListener('click', () => hideModal('raceHistoryModal'));
            
            document.getElementById('finalizeWeekendBtn').addEventListener('click', finalizeRaceWeekend);
            document.getElementById('finalizeSeasonBtn').addEventListener('click', finalizeSeason);
            document.getElementById('modalCancelBtn').addEventListener('click', () => hideModal('confirmationModal'));
            
            // --- Delegate Listeners for Edit/Delete ---
            document.getElementById('classList').addEventListener('click', (e) => {
                const classId = e.target.dataset.id;
                if (!classId) return;
                const cls = state.classes.find(c => c.id === classId);
                if(e.target.classList.contains('edit-class-btn')) {
                    document.getElementById('classId').value = cls.id;
                    document.getElementById('className').value = cls.name;
                    showModal('classModal');
                } else if (e.target.classList.contains('delete-class-btn')) {
                    showConfirmationModal(`Delete Class: ${cls.name}?`, `This cannot be undone.`, () => {
                        state.classes = state.classes.filter(c => c.id !== classId);
                        saveState();
                        renderAll();
                        showInfoModal('Success', `Class "${cls.name}" deleted.`);
                    });
                }
            });
            document.getElementById('classModalCancelBtn').addEventListener('click', () => hideModal('classModal'));
            document.getElementById('classForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const classId = document.getElementById('classId').value;
                const newName = document.getElementById('className').value;
                const classIndex = state.classes.findIndex(c => c.id === classId);
                if (classIndex > -1) {
                    state.classes[classIndex].name = newName;
                    saveState();
                    renderAll();
                }
                hideModal('classModal');
            });
            document.getElementById('driverList').addEventListener('click', (e) => {
                const driverId = e.target.closest('tr')?.dataset.driverId;
                if (!driverId) return;
                const driver = state.drivers.find(d => d.id === driverId);
                if (e.target.classList.contains('edit-driver-btn')) {
                    document.getElementById('driverId').value = driver.id;
                    document.getElementById('driverName').value = driver.name;
                    document.getElementById('driverNickname').value = driver.nickname || ''; // V3: New field
                    document.getElementById('driverNumber').value = driver.number;
                    document.getElementById('driverLicense').value = driver.license;
                    document.getElementById('driverPhone').value = driver.phone;
                    document.getElementById('driverAddress').value = driver.address || ''; // V3: New field
                    document.getElementById('driverCity').value = driver.city || ''; // V3: New field
                    document.getElementById('driverState').value = driver.state || ''; // V3: New field
                    document.getElementById('driverClass').value = driver.classId;
                    document.getElementById('driverSponsors').value = driver.sponsors || ''; // V4: New field
                    document.getElementById('driverFunFacts').value = driver.funFacts || ''; // V4: New field
                    document.getElementById('driverModalTitle').textContent = 'Edit Driver';
                    showModal('driverModal');
                } else if (e.target.classList.contains('delete-driver-btn')) {
                    showConfirmationModal(`Delete Driver: ${driver.name}?`, `This will permanently delete the driver and all season points.`, () => {
                         state.drivers = state.drivers.filter(d => d.id !== driverId);
                         delete state.seasonPoints[driverId];
                         saveState();
                         renderAll();
                         showInfoModal('Success', `Driver "${driver.name}" deleted.`);
                    });
                }
            });
            document.getElementById('pointsModalCancelBtn').addEventListener('click', () => hideModal('pointsModal'));
            document.getElementById('pointsList').addEventListener('click', (e) => {
                if (!e.target.classList.contains('edit-points-btn')) return;
                const driverId = e.target.closest('tr')?.dataset.driverId;
                const driver = state.drivers.find(d => d.id === driverId);
                document.getElementById('pointsModalTitle').textContent = `Edit Points for ${driver.name}`;
                document.getElementById('pointsDriverId').value = driverId;
                document.getElementById('newPoints').value = state.seasonPoints[driverId]?.points || 0;
                showModal('pointsModal');
            });
            document.getElementById('pointsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const driverId = document.getElementById('pointsDriverId').value;
                const newPoints = parseInt(document.getElementById('newPoints').value);
                if(isNaN(newPoints)) return;
                if(!state.seasonPoints[driverId]) {
                     const driver = state.drivers.find(d => d.id === driverId);
                     state.seasonPoints[driverId] = { points: 0, starts: 0, featureWins: 0, heatWins: 0, top5s: 0, top10s: 0, classId: driver.classId };
                }
                state.seasonPoints[driverId].points = newPoints;
                saveState();
                renderPointsPage(document.getElementById('pointsClassSelect').value);
                hideModal('pointsModal');
            });
            document.getElementById('passwordModalCancelBtn').addEventListener('click', () => hideModal('passwordModal'));
            document.getElementById('passwordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const passwordInput = document.getElementById('adminPassword');
                if (passwordInput.value === '35racewaypark') {
                    hideModal('passwordModal');
                    if (typeof _passwordProtectedAction === 'function') {
                        _passwordProtectedAction();
                        _passwordProtectedAction = null; // Reset after use
                    }
                } else {
                    document.getElementById('passwordError').classList.remove('hidden');
                }
            });

            // === SETTINGS SUB-TAB NAVIGATION ===
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.settingsTab;
                    
                    // Update active button styling
                    document.querySelectorAll('.settings-tab-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.currentTarget.classList.add('active');
                    
                    // Show/hide content panels
                    document.querySelectorAll('.settings-tab-content').forEach(content => {
                        content.classList.add('hidden');
                        content.classList.remove('active');
                    });
                    
                    if (tabName === 'points') {
                        const pointsPanel = document.getElementById('pointsSettings');
                        pointsPanel.classList.remove('hidden');
                        pointsPanel.classList.add('active');
                    } else if (tabName === 'payouts') {
                        const payoutsPanel = document.getElementById('payoutSettings');
                        payoutsPanel.classList.remove('hidden');
                        payoutsPanel.classList.add('active');
                        
                        // IMPORTANT: Render payouts when tab is shown
                        renderPayoutManagement();
                    }
                });
            });

            // === PAYOUT STRUCTURE MANAGEMENT ===
            
            // Create New Payout Structure Button
            const createPayoutBtn = document.getElementById('createPayoutStructureBtn');
            if (createPayoutBtn) {
                createPayoutBtn.addEventListener('click', () => {
                    // Reset form
                    document.getElementById('payoutStructureForm').reset();
                    document.getElementById('payoutStructureId').value = '';
                    document.getElementById('payoutStructureModalTitle').textContent = 'Create Payout Structure';
                    
                    // Generate 30 input fields for payout positions
                    const container = document.getElementById('payoutPositionsContainer');
                    container.innerHTML = '';
                    
                    for (let i = 0; i < 30; i++) {
                        container.innerHTML += `
                            <div class="flex items-center gap-2">
                                <label class="w-16 text-sm font-medium text-gray-700">${i + 1}:</label>
                                <span class="text-gray-500">$</span>
                                <input type="number" value="0" min="0" step="0.01" 
                                    class="payout-position-input flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-orange-500" 
                                    data-pos="${i}">
                            </div>
                        `;
                    }
                    
                    // Reset total
                    document.getElementById('modalTotalPurse').textContent = '0';
                    showModal('payoutStructureModal');
                });
            }
            
            // Edit/Delete payout structure
            const payoutList = document.getElementById('payoutStructuresList');
            if (payoutList) {
                payoutList.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-payout-btn')) {
                        const btn = e.target.closest('.edit-payout-btn');
                        const structure = state.payoutStructures.find(s => s.id === btn.dataset.id);
                        if (!structure) return;
                        
                        document.getElementById('payoutStructureId').value = structure.id;
                        document.getElementById('payoutStructureName').value = structure.name;
                        
                        const container = document.getElementById('payoutPositionsContainer');
                        container.innerHTML = '';
                        for (let i = 0; i < 30; i++) {
                            const value = structure.payouts[i] || 0;
                            container.innerHTML += `
                                <div class="flex items-center gap-2">
                                    <label class="w-16 text-sm font-medium">${i + 1}:</label>
                                    <span class="text-gray-500">$</span>
                                    <input type="number" value="${value}" min="0" step="0.01" 
                                        class="payout-position-input flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-orange-500" data-pos="${i}">
                                </div>
                            `;
                        }
                        
                        const total = structure.payouts.reduce((sum, p) => sum + (p || 0), 0);
                        document.getElementById('modalTotalPurse').textContent = total.toLocaleString();
                        document.getElementById('payoutStructureModalTitle').textContent = 'Edit Payout Structure';
                        showModal('payoutStructureModal');
                    }
                    
                    if (e.target.closest('.delete-payout-btn')) {
                        const btn = e.target.closest('.delete-payout-btn');
                        const structure = state.payoutStructures.find(s => s.id === btn.dataset.id);
                        if (!structure) return;
                        
                        showConfirmationModal('Delete Payout Structure?', 
                            `Delete "${structure.name}"?`, () => {
                            state.payoutStructures = state.payoutStructures.filter(s => s.id !== btn.dataset.id);
                            saveState();
                            renderPayoutManagement();
                        });
                    }
                });
            }
            
            // Live total calculation
            const payoutContainer = document.getElementById('payoutPositionsContainer');
            if (payoutContainer) {
                payoutContainer.addEventListener('input', () => {
                    const total = Array.from(document.querySelectorAll('.payout-position-input'))
                        .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
                    document.getElementById('modalTotalPurse').textContent = total.toLocaleString();
                });
            }
            
            // Save payout form
            const payoutForm = document.getElementById('payoutStructureForm');
            if (payoutForm) {
                payoutForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('payoutStructureId').value;
                    const name = document.getElementById('payoutStructureName').value.trim();
                    const payouts = Array.from(document.querySelectorAll('.payout-position-input'))
                        .map(input => parseInt(input.value) || 0);
                    
                    if (id) {
                        const structure = state.payoutStructures.find(s => s.id === id);
                        if (structure) {
                            structure.name = name;
                            structure.payouts = payouts;
                        }
                    } else {
                        state.payoutStructures.push({
                            id: generateUniqueId(),
                            name: name,
                            payouts: payouts
                        });
                    }
                    
                    saveState();
                    renderPayoutManagement();
                    hideModal('payoutStructureModal');
                });
            }
            
            const payoutCancelBtn = document.getElementById('payoutStructureModalCancelBtn');
            if (payoutCancelBtn) {
                payoutCancelBtn.addEventListener('click', () => {
                    hideModal('payoutStructureModal');
                });
            }

            // === LINEUP EDITOR ===
            
            // Handle Edit Lineup button clicks in heat races
            document.getElementById('heatLineupsContainer').addEventListener('click', (e) => {
                if (e.target.closest('.edit-lineup-btn')) {
                    const btn = e.target.closest('.edit-lineup-btn');
                    const heatIndex = btn.dataset.heatIndex;
                    const classId = document.getElementById('heatRacesClassSelect').value;
                    openLineupEditor('heat', classId, heatIndex);
                }
            });
            
            // Handle Edit Lineup button clicks in B-Main
            document.getElementById('bMainContainer').addEventListener('click', (e) => {
                if (e.target.closest('.edit-lineup-btn')) {
                    const classId = document.getElementById('bMainClassSelect').value;
                    openLineupEditor('bMain', classId);
                }
            });
            
            // Handle Edit Lineup button clicks in Feature
            document.getElementById('featureContainer').addEventListener('click', (e) => {
                if (e.target.closest('.edit-lineup-btn')) {
                    const classId = document.getElementById('featureClassSelect').value;
                    openLineupEditor('feature', classId);
                }
            });
            
            // Handle lineup editor modal interactions - SIMPLIFIED
            const lineupListContainer = document.getElementById('currentLineupList');
            if (lineupListContainer) {
                // Handle position input changes
                lineupListContainer.addEventListener('change', (e) => {
                    if (e.target.classList.contains('position-input')) {
                        e.preventDefault();
                        const newPos = parseInt(e.target.value);
                        const driverCard = e.target.closest('[data-driver-id]');
                        const driverId = driverCard.dataset.driverId;
                        
                        // Get current order from DOM
                        const cards = Array.from(lineupListContainer.querySelectorAll('[data-driver-id]'));
                        const currentLineupOrder = cards.map(c => c.dataset.driverId);
                        
                        const currentIndex = currentLineupOrder.indexOf(driverId);
                        
                        if (newPos >= 1 && newPos <= currentLineupOrder.length && newPos - 1 !== currentIndex) {
                            // Remove from current position
                            currentLineupOrder.splice(currentIndex, 1);
                            // Insert at new position
                            currentLineupOrder.splice(newPos - 1, 0, driverId);
                            
                            // Re-render with new order
                            const classId = document.getElementById('lineupEditorClassId').value;
                            renderCurrentLineup(currentLineupOrder, classId);
                        } else {
                            // Invalid position or same position - reset input to current
                            e.target.value = currentIndex + 1;
                        }
                    }
                });
            }
            
            
            // NOTE: Add driver handler now attached in openLineupEditor() to prevent duplicates
            
            // Handle save lineup button
            const saveLineupBtn = document.getElementById('lineupEditorSaveBtn');
            if (saveLineupBtn) {
                saveLineupBtn.addEventListener('click', saveLineupEdits);
            }
            
            // Handle cancel lineup button
            const cancelLineupBtn = document.getElementById('lineupEditorCancelBtn');
            if (cancelLineupBtn) {
                cancelLineupBtn.addEventListener('click', () => {
                    hideModal('lineupEditorModal');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', setupRaceManagerApp);
    </script>
</body>
</html>

